var lastselBco=0;function vta_cobros(){}function InitCob(){$("#dialogWait").dialog("open");myLayout.close("west");myLayout.close("east");myLayout.close("south");myLayout.close("north");d.getElementById("COB_TRX").focus();d.getElementById("COB_TRX").select();var strHtml="<ul>"+getMenuItem("SaveCob();","Guardar Cobro","images/ptovta/CircleSave.png")+getMenuItem("SalirCob();","Salir","images/ptovta/exitBig.png")+"</ul>";document.getElementById("TOOLBAR").innerHTML=strHtml;document.getElementById("COB_MONEDA_PAGO").disabled=true;document.getElementById("COB_FALTA_MAX").disabled=true;document.getElementById("ANTICIPO_TOTAL").disabled=true;document.getElementById("COB_NOM_CTE").disabled=true;document.getElementById("COB_NOCHEQUE").parentNode.parentNode.style.display="none";EsAnticipoCob();document.getElementById("TASA_CAMBIO_PAGO").disabled=true;document.getElementById("btn1").style.display="none";itemIdCob=0;$("#dialogWait").dialog("close");}var strNomFormCob="";var strKeyCob="";var strTipoVtaCob="";var strNomOrderCob="";var itemIdCob=0;var strNomFormatPrintCob="COBROS";var dblFaltaXPagar=0;var idAnticipo=0;var MonedaAPagar=0;function AddTrxInd(){getTrx(d.getElementById("COB_TRX"));}function AddTrxEvt(event,obj){if(event.keyCode==13){getTrx(obj);}}function getTrx(obj){var strPrefijoMaster="TKT";var strNomDoc="TICKET";strNomOrderCob="TKT_ID";strNomFormCob="TICKETVIEW";strKeyCob="TKT_ID";strTipoVtaCob="2";var strXmlIni="vta_ticketss";if(document.getElementById("COB_TIPO").value=="1"){strPrefijoMaster="FAC";strNomFormCob="FACTVIE";strNomOrderCob="FAC_ID";strKeyCob="FAC_ID";strTipoVtaCob="1";strXmlIni="vta_facturass";strNomDoc="FACTURA";}if(document.getElementById("COB_TIPO").value=="3"){strPrefijoMaster="PD";strNomFormCob="PEDIDOVIEW";strNomOrderCob="PD_ID";strKeyCob="PD_ID";strTipoVtaCob="3";strXmlIni="vta_pedidoss";strNomDoc="PEDIDO";}$.ajax({type:"POST",data:strPrefijoMaster+"_ID="+obj.value+"&"+strPrefijoMaster+"_ANULADA=999&EMP_ID="+intEMP_ID,scriptCharset:"utf-8",contentType:"application/x-www-form-urlencoded;charset=utf-8",cache:false,dataType:"xml",url:"CIP_TablaOp.jsp?ID=2&opnOpt="+strNomFormCob,success:function(datoVal){var objXML=datoVal.getElementsByTagName(strXmlIni)[0];if(objXML!=null){if(objXML.getAttribute(strPrefijoMaster+"_ANULADA")==0){d.getElementById("COB_NOM").value=objXML.getAttribute(strPrefijoMaster+"_RAZONSOCIAL");d.getElementById("COB_FOLIO").value=objXML.getAttribute(strPrefijoMaster+"_FOLIO");d.getElementById("COB_TOTTRX").value=FormatNumber(objXML.getAttribute(strPrefijoMaster+"_TOTAL"),intNumdecimal,true);d.getElementById("COB_TOTAL").value=FormatNumber(objXML.getAttribute(strPrefijoMaster+"_SALDO"),intNumdecimal,true);if(d.getElementById("TOTALXPAGAR")!=null){d.getElementById("TOTALXPAGAR").value=d.getElementById("COB_TOTAL").value;}d.getElementById("FPago1").value=0;SaveCobDo();}else{alert("EL "+strNomDoc+" "+obj.value+" con folio "+objXML.getAttribute(strPrefijoMaster+"_FOLIO")+" ESTA ANULADO");}}else{alert("EL "+strNomDoc+" "+obj.value+" NO EXISTE");}},error:function(objeto,quepaso,otroobj){alert(":ptoExist:"+objeto+" "+quepaso+" "+otroobj);$("#dialogWait").dialog("close");}});d.getElementById("COB_TRX").focus();d.getElementById("COB_TRX").select();}function resetCobroInd(){document.getElementById("COB_BCO").value=0;document.getElementById("COB_NOM").value="";document.getElementById("COB_FECHATRX").value="";document.getElementById("COB_CONCEPTO").value="";document.getElementById("METPAG").value="0";document.getElementById("COB_FOLIO").value="";document.getElementById("COB_NOCHEQUE").value="";document.getElementById("COB_TOTTRX").value="0.0";document.getElementById("COB_TOTAL").value="0.0";document.getElementById("COB_NOCHEQUE").value="";}function resetCobroMas(bolUpdateGrid){d.getElementById("COB_TOTAL").value=0;if(bolUpdateGrid){searchTrxMasiva();}else{jQuery("#COB_GRID1").clearGridData();}}function SaveCob(){var Sichecked=document.getElementById("COB_ESANTICIPO1").checked;if(Sichecked){SaveCobDo();}else{SaveCobDo();}}function SaveCobDo(){$("#dialogWait").dialog("open");var dblDev=0;var dblPagado=0;var dblxCobrar=0;var strPOST="";var $tabs=$("#tabsCOBROS").tabs();var selected=$tabs.tabs("option","active");if(selected==0){dblDev=0;dblPagado=parseFloat(d.getElementById("COB_TOTAL").value)-dblDev;strPOST="idTrx="+d.getElementById("COB_TRX").value;strPOST+="&TipoDoc="+encodeURIComponent(d.getElementById("COB_TIPO").value);strPOST+="&MONTOPAGO="+dblPagado;strPOST+="&FECHA="+(d.getElementById("COB_FECHATRX").value);strPOST+="&BC_ID="+(d.getElementById("COB_BCO").value);strPOST+="&NOTAS="+encodeURIComponent(d.getElementById("COB_CONCEPTO").value);strPOST+="&MONEDA=1";strPOST+="&TASAPESO=1";strPOST+="&COUNT_PAGOS=1";strPOST+="&MCD_MONEDA1=1";strPOST+="&MCD_FOLIO1=";switch(parseInt(d.getElementById("COB_METPAGO2").value)){case 1:strPOST+="&MCD_FORMAPAGO1=EFECTIVO";strPOST+="&MCD_NOCHEQUE1=";break;case 2:strPOST+="&MCD_FORMAPAGO1=CHEQUE";strPOST+="&MCD_NOCHEQUE1=";break;case 3:strPOST+="&MCD_FORMAPAGO1=TCREDITO";strPOST+="&MCD_NOCHEQUE1=";break;case 4:strPOST+="&MCD_FORMAPAGO1=SALDOFAVOR";strPOST+="&MCD_NOCHEQUE1=";break;case 5:strPOST+="&MCD_FORMAPAGO1=TRANSFERENCIA BANCARIA";strPOST+="&MCD_NOCHEQUE1=";break;}strPOST+="&MCD_BANCO1=";strPOST+="&MCD_NOTARJETA1=";strPOST+="&MCD_TIPOTARJETA1=";strPOST+="&MCD_IMPORTE1="+(dblPagado);strPOST+="&MCD_TASAPESO1=1";strPOST+="&MCD_CAMBIO1=0";document.getElementById("COB_BTN4").disabled=true;document.getElementById("TOOLBAR").style.display="none";$.ajax({type:"POST",data:encodeURI(strPOST),scriptCharset:"utf-8",contentType:"application/x-www-form-urlencoded;charset=utf-8",cache:false,dataType:"html",url:"Cobros.do?id=1",success:function(dato){dato=trim(dato);if(Left(dato,3)=="OK."){openFormat("COBROS","PDF",CreaHidden("MC_ID",dato.replace("OK.","")));resetCobroInd();document.getElementById("COB_BTN4").disabled=false;document.getElementById("TOOLBAR").style.display="block";d.getElementById("COB_TRX").value=0;d.getElementById("COB_TRX").focus();d.getElementById("COB_TRX").select();$("#dialogPagos").dialog("close");}else{alert(dato);}$("#dialogWait").dialog("close");},error:function(objeto,quepaso,otroobj){alert(":pto9:"+objeto+" "+quepaso+" "+otroobj);$("#dialogWait").dialog("close");}});}else{var intIdOper=3;var grid=jQuery("#COB_GRID1");var arr=grid.getDataIDs();var Sichecked=document.getElementById("COB_ESANTICIPO1").checked;var intContaPays=0;for(var i=0;i<arr.length;i++){var id=arr[i];var lstRow=grid.getRowData(id);if(lstRow.COBD_CTAS_IMPORTE>0){intContaPays++;}}if(Sichecked){dblDev=0;dblPagado=parseFloat(d.getElementById("COB_TOTAL2").value);dblxCobrar=parseFloat(d.getElementById("COB_TOTAL2").value);}else{dblDev=0;dblPagado=parseFloat(d.getElementById("COB_TOTAL2").value);dblxCobrar=parseFloat(d.getElementById("COB_TOTAL2").value);}if((dblPagado==dblxCobrar||((dblPagado!=dblxCobrar)&&intContaPays==1))&&dblxCobrar>0){strPOST+="FECHA="+(d.getElementById("COB_FECHA").value);strPOST+="&BC_ID="+(d.getElementById("COB_BCO").value);strPOST+="&NOTAS="+encodeURIComponent(d.getElementById("COB_CONCEPTO").value);strPOST+="&MONEDA="+(d.getElementById("TIPO_MONEDA_BANC").value);strPOST+="&TASAPESO="+(d.getElementById("TASA_CAMBIO_PAGO").value);strPOST+="&MONTOPAGOTOTAL="+dblPagado;strPOST+="&MONTOPAGOTOTALAMONEDA="+(d.getElementById("COB_TOTAL2").value);strPOST+="&MONEDAAPAGAR="+(d.getElementById("COB_MONEDA_PAGO").value);for(var i=0;i<arr.length;i++){var id=arr[i];var lstRow=grid.getRowData(id);if(lstRow.COBD_CTAS_IMPORTE>0){strPOST+="&idTrx="+lstRow.COBD_ID;strPOST+="&TipoDoc="+encodeURIComponent((lstRow.COBD_TIPO=="FACTURA")?1:2);strPOST+="&MONTOPAGO="+lstRow.COBD_CTAS_IMPORTE;}}var strNomForm="COBROSMAS";var strNomField="MCM_ID";if(arr.length==1){intIdOper=1;strNomForm="COBROS";strNomField="MC_ID";}if(Sichecked){strPOST+="&USA_ANTI="+1;strPOST+="&ANTI_ID="+idAnticipo;strPOST+="&CANTIDAD_ANTI="+(d.getElementById("ANTICIPO_USO").value);strPOST+="&MCD_IMPORTE1="+0;strPOST+="&COUNT_PAGOS=0";}else{if(d.getElementById("COB_FALTA_MAX").value>0){strPOST+="&CTE_ID="+(d.getElementById("COB_CTE").value);
strPOST+="&CTE_ANTICIPO="+(d.getElementById("COB_FALTA_MAX").value);}strPOST+="&COUNT_PAGOS=1";strPOST+="&MCD_MONEDA1=1";strPOST+="&MCD_FOLIO1=";switch(parseInt(d.getElementById("METPAG").value)){case 1:strPOST+="&MCD_FORMAPAGO1=EFECTIVO";strPOST+="&MCD_NOCHEQUE1=";break;case 2:strPOST+="&MCD_FORMAPAGO1=CHEQUE";strPOST+="&MCD_NOCHEQUE1="+d.getElementById("COB_NOCHEQUE").value;break;case 3:strPOST+="&MCD_FORMAPAGO1=TCREDITO";strPOST+="&MCD_NOCHEQUE1=";break;case 4:strPOST+="&MCD_FORMAPAGO1=SALDOFAVOR";strPOST+="&MCD_NOCHEQUE1=";break;case 5:strPOST+="&MCD_FORMAPAGO1=TRANSFERENCIA BANCARIA";strPOST+="&MCD_NOCHEQUE1=";break;}strPOST+="&MCD_BANCO1="+d.getElementById("COB_BCO").value;strPOST+="&MCD_NOTARJETA1=";strPOST+="&MCD_TIPOTARJETA1=";strPOST+="&MCD_IMPORTE1="+(parseFloat(d.getElementById("COB_TOTAL2").value));strPOST+="&MCD_TASAPESO1=1";strPOST+="&MCD_CAMBIO1=0.0";}$.ajax({type:"POST",data:encodeURI(strPOST),scriptCharset:"utf-8",contentType:"application/x-www-form-urlencoded;charset=utf-8",cache:false,dataType:"html",url:"Cobros.do?id="+intIdOper,success:function(dato){dato=trim(dato);if(Left(dato,3)=="OK."){openFormat(strNomForm,"PDF",CreaHidden(strNomField,dato.replace("OK.","")));jQuery("#COB_GRID1").clearGridData();if(Sichecked){CargaAnticiposCob();d.getElementById("COB_ESANTICIPO1").checked=true;}else{}document.getElementById("COB_MAX_PAGO").value="0.0";document.getElementById("COB_FALTA_MAX").value="0.0";document.getElementById("ANTICIPO_TOTAL").value="0.0";document.getElementById("ANTICIPO_USO").value="0.0";document.getElementById("COB_TOTAL2").value="0.0";itemIdCob=0;resetCobroMas(true);$("#dialogPagos").dialog("close");}else{alert(dato);}resetCobroInd();$("#dialogWait").dialog("close");},error:function(objeto,quepaso,otroobj){alert(":pto9:"+objeto+" "+quepaso+" "+otroobj);$("#dialogWait").dialog("close");}});}else{alert(lstMsg[10]);$("#dialogWait").dialog("close");}}}function OpnDiagCteCob(){OpnOpt("CLIENTES","grid","dialogCte",false,false);}function searchTrxMasiva(){BuscaTasaCambioCobPago();var Sichecked=document.getElementById("COB_ESANTICIPO1").checked;var boolHaceOperacion=true;var dblTasaCambio=document.getElementById("TASA_CAMBIO_PAGO").value;var strOperacion=document.getElementById("COB_OPERACION").value;if(strOperacion=="M"){dblTasaCambio=1/dblTasaCambio;}if(Sichecked){}else{if(d.getElementById("COB_BCO").value==0){boolHaceOperacion=false;alert("Te falta seleccionar el banco");}}if(boolHaceOperacion){itemIdCob=0;var strCte=d.getElementById("COB_CTE").value;var strFecha1=d.getElementById("COB_FECHAS1").value;var strFecha2=d.getElementById("COB_FECHAS2").value;var strMoneda=d.getElementById("COB_MONEDA").value;var strPOST="&TKT_MONEDA="+strMoneda;if(strFecha1!=""){strPOST+="&TKT_FECHA1="+strFecha1;}if(strFecha2==""){strFecha2=FechaActualCob();}strPOST+="&TKT_FECHA2="+strFecha2;ValidaClean("COB_CTE");if(strCte==0){ValidaShow("COB_CTE","NECESITA SELECCIONAR UN CLIENTE");}else{$("#dialogWait").dialog("open");strPOST+="&CT_ID="+strCte;resetCobroMas(false);$.ajax({type:"POST",data:strPOST,scriptCharset:"utf-8",contentType:"application/x-www-form-urlencoded;charset=utf-8",cache:false,dataType:"xml",url:"ERP_Cobros.jsp?id=16",success:function(datos){var objsc=datos.getElementsByTagName("tickets")[0];var lstTiks=objsc.getElementsByTagName("ticket");for(i=0;i<lstTiks.length;i++){var obj=lstTiks[i];var dblPagos=obj.getAttribute("TKT_TOTAL")-obj.getAttribute("TKT_SALDO");var strFecha=obj.getAttribute("TKT_FECHA");strFecha=strFecha.substr(strFecha.length-2,strFecha.length)+"/"+strFecha.substr(4,2)+"/"+strFecha.substr(0,4);var datarow={COBD_ID:obj.getAttribute("TKT_ID"),COBD_FOLIO:obj.getAttribute("TKT_FOLIO"),COBD_FECHA:strFecha,COBD_TOTAL:obj.getAttribute("TKT_TOTAL"),COBD_PAGOS:dblPagos,COBD_SALDO:obj.getAttribute("TKT_SALDO"),COBD_SALDO_CAMBIO:(parseFloat(obj.getAttribute("TKT_SALDO"))*parseFloat(dblTasaCambio)),COBD_TIPO:"TICKET"};itemIdCob++;jQuery("#COB_GRID1").addRowData(itemIdCob,datarow,"last");}var objsc=datos.getElementsByTagName("facturas")[0];var lstTiks=objsc.getElementsByTagName("factura");for(i=0;i<lstTiks.length;i++){var obj=lstTiks[i];var dblPagos=obj.getAttribute("FAC_TOTAL")-obj.getAttribute("FAC_SALDO");var strFecha=obj.getAttribute("FAC_FECHA");var dblSaldoCambio=parseFloat(obj.getAttribute("FAC_SALDO"))*parseFloat(dblTasaCambio);strFecha=strFecha.substr(strFecha.length-2,strFecha.length)+"/"+strFecha.substr(4,2)+"/"+strFecha.substr(0,4);var datarow={COBD_ID:obj.getAttribute("FAC_ID"),COBD_FOLIO:obj.getAttribute("FAC_FOLIO"),COBD_FECHA:strFecha,COBD_TOTAL:obj.getAttribute("FAC_TOTAL"),COBD_PAGOS:dblPagos,COBD_SALDO:obj.getAttribute("FAC_SALDO"),COBD_SALDO_CAMBIO:dblSaldoCambio,COBD_TIPO:"FACTURA"};itemIdCob++;jQuery("#COB_GRID1").addRowData(itemIdCob,datarow,"last");}document.getElementById("ANTICIPO_USO").value=document.getElementById("ANTICIPO_TOTAL").value;document.getElementById("COB_FALTA_MAX").value=document.getElementById("COB_MAX_PAGO").value;document.getElementById("TASA_CAMBIO_PAGO").disabled=false;$("#dialogWait").dialog("close");},error:function(objeto,quepaso,otroobj){alert(":ptoExist:"+objeto+" "+quepaso+" "+otroobj);$("#dialogWait").dialog("close");}});}document.getElementById("COB_TOTAL2").value=0;ValidaMaximoxPagarCob();}else{d.getElementById("COB_MONEDA").focus();}}function selRowCob(rowid,status){editFila(rowid);Recalculo();}function ShowPayments(){OpnOpt("COBROSVIEW","grid","dialog2",false,false);}function PagosPrint(){var grid=jQuery("#COBROSVIEW");if(grid.getGridParam("selrow")!=null){var lstRow=grid.getRowData(grid.getGridParam("selrow"));if(lstRow.MC_ANULADO=="NO"){if(lstRow.MCM_ID!=0){openFormat("COBROSMAS","PDF",CreaHidden("MCM_ID",lstRow.MCM_ID));}else{openFormat(strNomFormatPrintCob,"PDF",CreaHidden("MC_ID",lstRow.MC_ID));}}}}function PagosAnul(){var grid=jQuery("#COBROSVIEW");if(grid.getGridParam("selrow")!=null){var lstRow=grid.getRowData(grid.getGridParam("selrow"));if(lstRow.MC_ANULADO=="NO"){$("#SioNO").dialog("open");$("#SioNO").dialog("option","title",lstMsg[17]);document.getElementById("btnSI").onclick=function(){$("#SioNO").dialog("close");PagosAnulDo();};document.getElementById("btnNO").onclick=function(){$("#SioNO").dialog("close");};}}}function PagosAnulDo(){var grid=jQuery("#COBROSVIEW");if(grid.getGridParam("selrow")!=null){var lstRow=grid.getRowData(grid.getGridParam("selrow"));if(lstRow.MC_ANULADO=="NO"){$("#dialogWait").dialog("open");var intKey=lstRow.MC_ID;var intId=2;var strNomKey="MC_ID";if(lstRow.MCM_ID!=0){intId=4;intKey=lstRow.MCM_ID;strNomKey="MCM_ID";}$.ajax({type:"POST",data:encodeURI(strNomKey+"="+intKey),scriptCharset:"utf-8",contentType:"application/x-www-form-urlencoded;charset=utf-8",cache:false,dataType:"html",url:"Cobros.do?id="+intId,success:function(dato){dato=trim(dato);if(Left(dato,2)=="OK"){grid.trigger("reloadGrid");}else{alert(dato);}$("#dialogWait").dialog("close");},error:function(objeto,quepaso,otroobj){alert(":conanul:"+objeto+" "+quepaso+" "+otroobj);$("#dialogWait").dialog("close");}});}else{alert(lstMsg[16]);}}}function SalirCob(){$("#dialogWait").dialog("open");$("#dialogWait").dialog("close");myLayout.open("west");myLayout.open("east");myLayout.open("south");myLayout.open("north");document.getElementById("MainPanel").innerHTML="";var objMainFacPedi=objMap.getScreen("COBROS");objMainFacPedi.bolActivo=false;objMainFacPedi.bolMain=false;objMainFacPedi.bolInit=false;objMainFacPedi.idOperAct=0;}function editGrid(e){if(e.originalEvent.keyCode==13){var dblFaltaParaPagar=dblFaltaXPagar;var dblTasaCambio=parseFloat(document.getElementById("TASA_CAMBIO_PAGO").value);var strOperacion=document.getElementById("COB_OPERACION").value;var grid=jQuery("#COB_GRID1");var lstRow=grid.getRowData(lastselBco);var dato=0;if(document.getElementById((lastselBco)+"_COBD_CTAS_IMPORTE").value!=null){dato=document.getElementById((lastselBco)+"_COBD_CTAS_IMPORTE").value;}if(strOperacion=="D"){dblTasaCambio=1/dblTasaCambio;}var dblAPagar=0;if((parseFloat(dato)<dblFaltaXPagar)){if((parseFloat(dato)*dblTasaCambio)<=parseFloat(lstRow.COBD_SALDO)){dblAPagar=dato;
}else{dblAPagar=parseFloat(lstRow.COBD_SALDO)/dblTasaCambio;}}else{dblAPagar=dblFaltaParaPagar;}$("#dialogWait").dialog("open");lstRow.COBD_CTAS_IMPORTE=dblAPagar;lstRow.COBD_CTAS_IMP_CAMBIO=dblAPagar*dblTasaCambio;grid.setRowData(lastselBco,lstRow);$("#dialogWait").dialog("close");grid.saveRow(lastselBco);Recalculo();lastselBco=0;}}function editFila(id){var grid=jQuery("#COB_GRID1");if(id!=lastselBco){grid.saveRow(lastselBco);grid.editRow(id,false);lastselBco=id;}}function Recalculo(){setTimeout(function(){var grid=jQuery("#COB_GRID1");var arr=grid.getDataIDs();var dblTotal=0;var dblNumero;var dblTasaCambio=parseFloat(document.getElementById("TASA_CAMBIO_PAGO").value);var dblTotalAntes=0;var strOperacion2=document.getElementById("COB_OPERACION").value;var dblOperacion=1;if(strOperacion2=="D"){dblOperacion=dblTasaCambio;dblTasaCambio=1/dblTasaCambio;}for(var i=0;i<arr.length;i++){var idRow=arr[i];dblNumero=0;var lstRow=grid.getRowData(idRow);if(document.getElementById(idRow+"_COBD_CTAS_IMPORTE")!=null){dblNumero=parseFloat(document.getElementById(idRow+"_COBD_CTAS_IMPORTE").value);var Sichecked=document.getElementById("COB_ESANTICIPO1").checked;if(Sichecked){dblCantidadMaximaPago=document.getElementById("ANTICIPO_TOTAL").value;dblFaltaXPagar=document.getElementById("ANTICIPO_USO").value;}else{dblCantidadMaximaPago=document.getElementById("COB_MAX_PAGO").value;dblFaltaXPagar=document.getElementById("COB_FALTA_MAX").value;}var dblImporteAPagar=parseFloat(lstRow.COBD_SALDO)*dblTasaCambio;if(dblCantidadMaximaPago<=0){alert("No hay cantidad minima para pagar.");}else{if((dblFaltaXPagar*dblTasaCambio)>parseFloat(lstRow.COBD_SALDO)){if((dblImporteAPagar>lstRow.COBD_SALDO)){dblImporteAPagar=lstRow.COBD_SALDO/dblTasaCambio*dblOperacion;}else{dblImporteAPagar=lstRow.COBD_SALDO*dblOperacion;}}else{dblImporteAPagar=dblFaltaXPagar;}}document.getElementById(idRow+"_COBD_CTAS_IMPORTE").value=dblImporteAPagar;}else{if(lstRow.COBD_CTAS_IMPORTE==""){dblNumero=0;}else{dblNumero=parseFloat(lstRow.COBD_CTAS_IMPORTE);}}dblTotal+=dblNumero*(dblTasaCambio);dblTotalAntes+=dblNumero;}d.getElementById("COB_TOTAL").value=FormatNumber(dblTotalAntes*dblTasaCambio,2,true);d.getElementById("COB_TOTAL2").value=FormatNumber(dblTotalAntes,2,true);if(dblTotal==0){document.getElementById("COB_BCO").disabled=false;}else{document.getElementById("COB_MONEDA_PAGO").disabled=true;}if(parseFloat(document.getElementById("COB_MAX_PAGO").value)!=0&&document.getElementById("COB_MAX_PAGO").value!=""){CalculaFaltaxPagarCob();}if(parseFloat(document.getElementById("ANTICIPO_TOTAL").value)!=0&&document.getElementById("ANTICIPO_TOTAL").value!=""){CalculaFaltaxPagarCob();}},300);}function CambiaBanco(){var intBanco=parseInt(document.getElementById("COB_BCO").value);var strPOST="&BC_ID="+intBanco;$.ajax({type:"POST",data:strPOST,scriptCharset:"utf-8",contentType:"application/x-www-form-urlencoded;charset=utf-8",cache:false,dataType:"html",url:"ERP_Cobros.jsp?id=7",success:function(datos){document.getElementById("TIPO_MONEDA_BANC").value=datos;document.getElementById("COB_MONEDA_PAGO").value=datos;BuscaTasaCambioCobPago();},error:function(objeto,quepaso,otroobj){alert(":ptoExist:"+objeto+" "+quepaso+" "+otroobj);$("#dialogWait").dialog("close");}});}function BuscaTasaCambio(){var intMonedaBanco=document.getElementById("TIPO_MONEDA_BANC").value;var intMonedaSeleccionada=document.getElementById("COB_MONEDA").value;var strFecha=document.getElementById("COB_FECHA").value;var strPOST="&Moneda_1="+intMonedaSeleccionada;strPOST+="&Moneda_2="+intMonedaBanco;strPOST+="&fecha="+strFecha;if(intMonedaBanco==intMonedaSeleccionada){document.getElementById("TASA_CAMBIO_PAGO").value=1;document.getElementById("TASA_CAMBIO_PAGO").disabled=true;}else{document.getElementById("TASA_CAMBIO_PAGO").disabled=false;$.ajax({type:"POST",data:strPOST,scriptCharset:"utf-8",contentType:"application/x-www-form-urlencoded;charset=utf-8",cache:false,dataType:"xml",url:"ERP_Cobros.jsp?id=9",success:function(datos){var objsc=datos.getElementsByTagName("TasaCambio")[0];var lstTiks=objsc.getElementsByTagName("TasaCambios");var obj=lstTiks[0];var dblTC=obj.getAttribute("TC");var strOperacion=obj.getAttribute("Operacion");document.getElementById("COB_OPERACION").value=strOperacion;if(dblTC==0){dblTC=1;}document.getElementById("TASA_CAMBIO_PAGO").value=dblTC;},error:function(objeto,quepaso,otroobj){alert(":ptoExist:"+objeto+" "+quepaso+" "+otroobj);$("#dialogWait").dialog("close");}});}Recalculo();}function Prueba(){var dblFaltaParaPagar=dblFaltaXPagar;var grid=jQuery("#COB_GRID1");var lstRow=grid.getRowData(lastselBco);var dblTasaCambio=parseFloat(document.getElementById("TASA_CAMBIO_PAGO").value);var dato=document.getElementById((lastselBco)+"_COBD_CTAS_IMPORTE").value;var strOperacion=document.getElementById("COB_OPERACION").value;if(strOperacion=="D"){dblTasaCambio=1/dblTasaCambio;}var dblAPagar=0;if((parseFloat(dato)<dblFaltaXPagar)){if((parseFloat(dato)*dblTasaCambio)<=parseFloat(lstRow.COBD_SALDO)){dblAPagar=dato;}else{dblAPagar=parseFloat(lstRow.COBD_SALDO)/dblTasaCambio;}}else{dblAPagar=dblFaltaParaPagar;}$("#dialogWait").dialog("open");lstRow.COBD_CTAS_IMPORTE=dblAPagar;lstRow.COBD_CTAS_IMP_CAMBIO=dblAPagar*dblTasaCambio;grid.setRowData(lastselBco,lstRow);$("#dialogWait").dialog("close");grid.saveRow(lastselBco);Recalculo();lastselBco=0;}function GuardaAjustaPago(){$("#dialogWait").dialog("open");var dblDev=0;var dblPagado=0;var dblxCobrar=0;var strPOST="";var intIdOper=3;var grid=jQuery("#COB_GRID1");var arr=grid.getDataIDs();var intContaPays=0;for(var i=0;i<arr.length;i++){var id=arr[i];var lstRow=grid.getRowData(id);if(lstRow.COBD_CTAS_IMPORTE>0){intContaPays++;}}dblDev=0;dblPagado=0-dblDev;dblxCobrar=parseFloat(d.getElementById("COB_TOTAL").value);if(dblxCobrar>0){var strMoneda=d.getElementById("COB_MONEDA").value;strPOST+="FECHA="+(d.getElementById("COB_FECHA").value);strPOST+="&NOTAS="+encodeURIComponent(d.getElementById("COB_CONCEPTO").value);strPOST+="&MONEDA="+strMoneda;strPOST+="&TASAPESO=1";strPOST+="&MONTOPAGOTOTAL="+dblPagado;strPOST+="&SIN_BANCO=1";for(var i=0;i<arr.length;i++){var id=arr[i];var lstRow=grid.getRowData(id);if(lstRow.COBD_CTAS_IMPORTE>0){strPOST+="&idTrx="+lstRow.COBD_ID;strPOST+="&TipoDoc="+encodeURIComponent((lstRow.COBD_TIPO=="FACTURA")?1:2);strPOST+="&MONTOPAGO="+lstRow.COBD_CTAS_IMPORTE;}}var strNomForm="COBROSMAS";var strNomField="MCM_ID";strPOST+="&COUNT_PAGOS=5";strPOST+="&MCD_MONEDA1="+strMoneda;strPOST+="&MCD_FOLIO1=";strPOST+="&MCD_FORMAPAGO1=EFECTIVO";strPOST+="&MCD_NOCHEQUE1=";strPOST+="&MCD_BANCO1=";strPOST+="&MCD_NOTARJETA1=";strPOST+="&MCD_TIPOTARJETA1=";strPOST+="&MCD_IMPORTE1="+0;strPOST+="&MCD_TASAPESO1=1";strPOST+="&MCD_CAMBIO1="+0;strPOST+="&MCD_MONEDA2="+strMoneda;strPOST+="&MCD_FOLIO2=";strPOST+="&MCD_FORMAPAGO2=CHEQUE";strPOST+="&MCD_NOCHEQUE2="+0;strPOST+="&MCD_BANCO2="+0;strPOST+="&MCD_NOTARJETA2=";strPOST+="&MCD_TIPOTARJETA2=";strPOST+="&MCD_IMPORTE2="+0;strPOST+="&MCD_TASAPESO2=1";strPOST+="&MCD_CAMBIO2=0";strPOST+="&MCD_MONEDA3="+strMoneda;strPOST+="&MCD_FOLIO3=";strPOST+="&MCD_FORMAPAGO3=TCREDITO";strPOST+="&MCD_NOCHEQUE3=";strPOST+="&MCD_BANCO3=";strPOST+="&MCD_NOTARJETA3="+0;strPOST+="&MCD_TIPOTARJETA3="+0;strPOST+="&MCD_IMPORTE3="+0;strPOST+="&MCD_TASAPESO3=1";strPOST+="&MCD_CAMBIO3=0";strPOST+="&MCD_MONEDA4="+strMoneda;strPOST+="&MCD_FOLIO4=";strPOST+="&MCD_FORMAPAGO4=SALDOFAVOR";strPOST+="&MCD_NOCHEQUE4=";strPOST+="&MCD_BANCO4=";strPOST+="&MCD_NOTARJETA4=";strPOST+="&MCD_TIPOTARJETA4=";strPOST+="&MCD_IMPORTE4="+0;strPOST+="&MCD_TASAPESO4=1";strPOST+="&MCD_CAMBIO4=0";strPOST+="&MCD_MONEDA5="+strMoneda;strPOST+="&MCD_FOLIO5=";strPOST+="&MCD_FORMAPAGO5=TRANSFERENCIA BANCARIA";strPOST+="&MCD_NOCHEQUE5=";strPOST+="&MCD_BANCO5="+0;strPOST+="&MCD_NOTARJETA5="+0;strPOST+="&MCD_TIPOTARJETA5=";strPOST+="&MCD_IMPORTE5="+0;strPOST+="&MCD_TASAPESO5=1";strPOST+="&MCD_CAMBIO5=0";$.ajax({type:"POST",data:encodeURI(strPOST),scriptCharset:"utf-8",contentType:"application/x-www-form-urlencoded;charset=utf-8",cache:false,dataType:"html",url:"Cobros.do?id="+intIdOper,success:function(dato){dato=trim(dato);
if(Left(dato,3)=="OK."){openFormat(strNomForm,"PDF",CreaHidden(strNomField,dato.replace("OK.","")));LimpiarGrid();resetCobroMasAjustaPago(true);$("#dialogPagos").dialog("close");}else{alert(dato);}$("#dialogWait").dialog("close");},error:function(objeto,quepaso,otroobj){alert(":pto9:"+objeto+" "+quepaso+" "+otroobj);$("#dialogWait").dialog("close");}});}else{alert(lstMsg[10]);$("#dialogWait").dialog("close");}LimpiarGrid();}function CargaAjustaPago(){var strCte=d.getElementById("COB_CTE").value;var strFecha1=d.getElementById("COB_FECHAS1").value;var strFecha2=d.getElementById("COB_FECHAS2").value;var strMoneda=d.getElementById("COB_MONEDA").value;var strPOST="&TKT_ANULADA=0&TKT_ESRECU=999&TKT_MONEDA="+strMoneda;if(strFecha1!=""){strPOST+="&TKT_FECHA1="+strFecha1;}if(strFecha2==""){strFecha2=FechaActualCob();}strPOST+="&TKT_FECHA2="+strFecha2;itemIdCob=0;ValidaClean("COB_CTE");if(strCte==0){ValidaShow("COB_CTE","NECESITA SELECCIONAR UN CLIENTE");}else{$("#dialogWait").dialog("open");resetCobroMas(false);$.ajax({type:"POST",data:strPOST,scriptCharset:"utf-8",contentType:"application/x-www-form-urlencoded;charset=utf-8",cache:false,dataType:"xml",url:"ERP_Cobros.jsp?id=16",success:function(datos){var objsc=datos.getElementsByTagName("tickets")[0];var lstTiks=objsc.getElementsByTagName("ticket");for(i=0;i<lstTiks.length;i++){var obj=lstTiks[i];if(obj.getAttribute("TKT_SALDO")>0){var dblPagos=obj.getAttribute("TKT_TOTAL")-obj.getAttribute("TKT_SALDO");var strFecha=obj.getAttribute("TKT_FECHA");strFecha=strFecha.substr(strFecha.length-2,strFecha.length)+"/"+strFecha.substr(4,2)+"/"+strFecha.substr(0,4);var datarow={COBD_ID:obj.getAttribute("TKT_ID"),COBD_FOLIO:obj.getAttribute("TKT_FOLIO"),COBD_FECHA:strFecha,COBD_TOTAL:obj.getAttribute("TKT_TOTAL"),COBD_PAGOS:dblPagos,COBD_SALDO:obj.getAttribute("TKT_SALDO"),COBD_TIPO:"TICKET"};itemIdCob++;jQuery("#COB_GRID1").addRowData(itemIdCob,datarow,"last");}}var objsc=datos.getElementsByTagName("facturas")[0];var lstTiks=objsc.getElementsByTagName("factura");for(i=0;i<lstTiks.length;i++){var obj=lstTiks[i];if(obj.getAttribute("FAC_SALDO")>0){var dblPagos=obj.getAttribute("FAC_TOTAL")-obj.getAttribute("FAC_SALDO");var strFecha=obj.getAttribute("FAC_FECHA");strFecha=strFecha.substr(strFecha.length-2,strFecha.length)+"/"+strFecha.substr(4,2)+"/"+strFecha.substr(0,4);var datarow={COBD_ID:obj.getAttribute("FAC_ID"),COBD_FOLIO:obj.getAttribute("FAC_FOLIO"),COBD_FECHA:strFecha,COBD_TOTAL:obj.getAttribute("FAC_TOTAL"),COBD_PAGOS:dblPagos,COBD_SALDO:obj.getAttribute("FAC_SALDO"),COBD_TIPO:"FACTURA"};itemIdCob++;jQuery("#COB_GRID1").addRowData(itemIdCob,datarow,"last");}}$("#dialogWait").dialog("close");},error:function(objeto,quepaso,otroobj){alert(":ptoExist:"+objeto+" "+quepaso+" "+otroobj);$("#dialogWait").dialog("close");}});}}function LimpiarGrid(){jQuery("#COB_GRID1").clearGridData();itemIdCob=0;CargaAjustaPago();}function resetCobroMasAjustaPago(bolUpdateGrid){d.getElementById("COB_TOTAL").value=0;if(bolUpdateGrid){}else{jQuery("#COB_GRID1").clearGridData();}}function CargaAnticiposCob(){$("#dialogWait").dialog("open");var intCT=document.getElementById("COB_CTE").value;var intMonPago=document.getElementById("COB_MONEDA_PAGO").value;var intMonDoc=document.getElementById("COB_MONEDA").value;document.getElementById("TASA_CAMBIO_PAGO").disabled=false;document.getElementById("COB_TASA_CAMBIO").disabled=false;var strPOST="CT_ID="+intCT;strPOST+="&MONEDAPAGO="+intMonPago;$.ajax({type:"POST",data:strPOST,scriptCharset:"utf-8",contentType:"application/x-www-form-urlencoded;charset=utf-8",cache:false,dataType:"xml",url:"ERP_Cobros.jsp?id=13",success:function(datos){var objsc=datos.getElementsByTagName("Anticipos")[0];var lstAnticipos=objsc.getElementsByTagName("Anticipo");jQuery("#GRID_ANTICIPOS").clearGridData();document.getElementById("COB_ESANTICIPO1").disabled=false;if(lstAnticipos.length!=0){for(var i=0;i<lstAnticipos.length;i++){var obj=lstAnticipos[i];var strFecha=obj.getAttribute("MC_FECHA");var intMoneda=parseInt(obj.getAttribute("MC_MONEDA"));var txtMONEDA="";if(intMoneda==1){txtMONEDA="PESOS";}else{if(intMoneda==2){txtMONEDA="DOLARES";}else{if(intMoneda==3){txtMONEDA="EUROS";}}}strFecha=strFecha.substr(strFecha.length-2,strFecha.length)+"/"+strFecha.substr(4,2)+"/"+strFecha.substr(0,4);var datarow={ANTI_ID:obj.getAttribute("MC_ID"),ANTI_FECHA:strFecha,ANTI_ABONO:obj.getAttribute("MC_SALDO_ANTICIPO"),ANTI_FOLIO:obj.getAttribute("MC_FOLIO"),ANTI_MONEDA:obj.getAttribute("MC_MONEDA"),ANTI_TASAPESO:obj.getAttribute("MC_TASAPESO"),ANTI_ORIGINAL:obj.getAttribute("MC_ANTICIPO_ORIGINAL"),ANTI_MONEDA_LETRA:txtMONEDA};jQuery("#GRID_ANTICIPOS").addRowData(i,datarow,"last");}$("#dialogWait").dialog("close");}else{alert("El cliente seeleccionado no tiene anticipos");document.getElementById("COB_ESANTICIPO1").disabled=true;document.getElementById("COB_ESANTICIPO2").checked=true;$("#dialogWait").dialog("close");$("#GRID_ANTICIPOS").jqGrid("setGridState","hidden");EsAnticipoCob();}},error:function(objeto,quepaso,otroobj){alert(":ptoExist:"+objeto+" "+quepaso+" "+otroobj);$("#dialogWait").dialog("close");}});}function ChecaCopatibilidadMonedaCob(){var intMonPago=document.getElementById("COB_MONEDA_PAGO").value;var intMonBanco=document.getElementById("TIPO_MONEDA_BANC").value;if(intMonPago==0||intMonBanco==0){}else{if(intMonBanco!=intMonPago){alert("Se debe Pagar con la misma moneda en la que esta el banco");return false;}}return true;}function PeticionMonedaProvCob(){$("#dialogWait").dialog("open");document.getElementById("COB_BCO").value=0;var strCT_ID=document.getElementById("COB_CTE").value;var strPOST="CT_ID="+strCT_ID;$.ajax({type:"POST",data:encodeURI(strPOST),scriptCharset:"utf-8",contentType:"application/x-www-form-urlencoded;charset=utf-8",cache:false,dataType:"html",url:"ERP_Cobros.jsp?id=14",success:function(dato){if(!isNaN(dato)){ObtenNomCteAntCobros();document.getElementById("COB_MONEDA").value=dato;document.getElementById("COB_MONEDA_PAGO").value=dato;jQuery("#GRID_ANTICIPOS").clearGridData();jQuery("#COB_GRID1").clearGridData();document.getElementById("COB_TOTAL2").value=0;document.getElementById("COB_ESANTICIPO2").checked=true;document.getElementById("COB_ESANTICIPO1").disabled=false;EsAnticipoCob();}$("#dialogWait").dialog("close");},error:function(objeto,quepaso,otroobj){alert(":pto9:"+objeto+" "+quepaso+" "+otroobj);$("#dialogWait").dialog("close");}});}function EsAnticipoCob(){var Sichecked=document.getElementById("COB_ESANTICIPO1").checked;if(Sichecked){document.getElementById("COB_MAX_PAGO").parentNode.parentNode.style.display="none";document.getElementById("COB_FALTA_MAX").parentNode.parentNode.style.display="none";document.getElementById("COB_MAX_PAGO").value=0;document.getElementById("COB_FALTA_MAX").value=0;document.getElementById("COB_BCO").parentNode.parentNode.style.display="none";document.getElementById("METPAG").parentNode.parentNode.style.display="none";document.getElementById("COB_BTN2").parentNode.parentNode.style.display="none";document.getElementById("ANTICIPO_TOTAL").parentNode.parentNode.style.display="block";document.getElementById("ANTICIPO_USO").parentNode.parentNode.style.display="block";document.getElementById("COB_NOCHEQUE").parentNode.parentNode.style.display="none";$("#GRID_ANTICIPOS").jqGrid("setGridState","visible");CargaAnticiposCob();}else{document.getElementById("COB_MAX_PAGO").parentNode.parentNode.style.display="block";document.getElementById("COB_FALTA_MAX").parentNode.parentNode.style.display="block";document.getElementById("COB_BCO").parentNode.parentNode.style.display="block";document.getElementById("METPAG").parentNode.parentNode.style.display="block";document.getElementById("COB_BTN2").parentNode.parentNode.style.display="block";document.getElementById("ANTICIPO_TOTAL").parentNode.parentNode.style.display="none";document.getElementById("ANTICIPO_USO").parentNode.parentNode.style.display="none";document.getElementById("ANTICIPO_TOTAL").value=0;document.getElementById("ANTICIPO_USO").value=0;
$("#GRID_ANTICIPOS").jqGrid("setGridState","hidden");jQuery("#GRID_ANTICIPOS").clearGridData();}RevisaMetodoPagoCob();}function FechaActualCob(){var fechaActual=new Date();var dia=fechaActual.getDate();var mes=fechaActual.getMonth()+1;var anio=fechaActual.getYear();if(dia<10){dia="0"+dia;}if(mes<10){mes="0"+mes;}if(anio<1000){anio+=1900;}var fechaHoy=dia+"/"+mes+"/"+anio;return fechaHoy;}function selAntiRowCob(rowid,status){var grid=jQuery("#GRID_ANTICIPOS");var lstRow=grid.getRowData(rowid);document.getElementById("ANTICIPO_TOTAL").value=lstRow.ANTI_ABONO;document.getElementById("ANTICIPO_USO").value=lstRow.ANTI_ABONO;document.getElementById("COB_MONEDA_PAGO").value=lstRow.ANTI_MONEDA;document.getElementById("TIPO_MONEDA_BANC").value=lstRow.ANTI_MONEDA;var intMonDoc=document.getElementById("COB_MONEDA").value;idAnticipo=lstRow.ANTI_ID;document.getElementById("TASA_CAMBIO_PAGO").value=FormatNumber(lstRow.ANTI_TASAPESO,intNumdecimal,true);if(lstRow.ANTI_MONEDA==1&&intMonDoc==2){document.getElementById("COB_OPERACION").value="D";}else{if(lstRow.ANTI_MONEDA==2&&intMonDoc==1){document.getElementById("COB_OPERACION").value="M";}else{if(lstRow.ANTI_MONEDA==2&&intMonDoc==3){document.getElementById("COB_OPERACION").value="D";}else{if(lstRow.ANTI_MONEDA==3&&intMonDoc==2){document.getElementById("COB_OPERACION").value="M";}}}}}function RevisaMetodoPagoCob(){var Seleccion=parseInt(document.getElementById("METPAG").value);var Sichecked=document.getElementById("COB_ESANTICIPO1").checked;if(Sichecked){document.getElementById("COB_NOCHEQUE").parentNode.parentNode.style.display="none";}else{if(Seleccion==2){document.getElementById("COB_NOCHEQUE").parentNode.parentNode.style.display="block";}else{document.getElementById("COB_NOCHEQUE").parentNode.parentNode.style.display="none";}}}function CalculaFaltaxPagarCob(){var Sichecked=document.getElementById("COB_ESANTICIPO1").checked;if(Sichecked){dblCantidadMaximaPago=(document.getElementById("ANTICIPO_TOTAL").value);}else{dblCantidadMaximaPago=(document.getElementById("COB_MAX_PAGO").value);}var dblTotal=parseFloat(document.getElementById("COB_TOTAL2").value);if(isNaN(dblCantidadMaximaPago)){dblCantidadMaximaPago=0;}if(isNaN(dblFaltaXPagar)){dblFaltaXPagar=0;}if(dblCantidadMaximaPago==0){dblFaltaXPagar=0;}dblFaltaXPagar=dblCantidadMaximaPago-dblTotal;if(Sichecked){document.getElementById("ANTICIPO_TOTAL").value=FormatNumber(dblCantidadMaximaPago,intNumdecimal,true);document.getElementById("ANTICIPO_USO").value=FormatNumber(dblFaltaXPagar,intNumdecimal,true);}else{document.getElementById("COB_MAX_PAGO").value=FormatNumber(dblCantidadMaximaPago,intNumdecimal,true);document.getElementById("COB_FALTA_MAX").value=FormatNumber(dblFaltaXPagar,intNumdecimal,true);}}function ValidaMaximoxPagarCob(){var dblMaxPagar=parseFloat(document.getElementById("COB_MAX_PAGO").value);if(dblMaxPagar<0){alert("El pago minimo debe ser positivo o cero");document.getElementById("COB_MAX_PAGO").focus();}else{CalculaFaltaxPagarCob();var Sichecked=document.getElementById("COB_ESANTICIPO2").checked;if(Sichecked){dblCantidadMaximaPago=parseFloat(document.getElementById("COB_MAX_PAGO").value);}}}function BuscaTasaCambioCobPago(){var intMonedaBanco=document.getElementById("COB_MONEDA").value;var intMonedaSeleccionada=document.getElementById("COB_MONEDA_PAGO").value;var strFecha=document.getElementById("COB_FECHA").value;var strPOST="&Moneda_1="+intMonedaSeleccionada;strPOST+="&Moneda_2="+intMonedaBanco;strPOST+="&fecha="+strFecha;$.ajax({type:"POST",data:strPOST,scriptCharset:"utf-8",contentType:"application/x-www-form-urlencoded;charset=utf-8",cache:false,dataType:"xml",url:"ERP_CobrosCuentas.jsp?id=9",success:function(datos){var objsc=datos.getElementsByTagName("TasaCambio")[0];var lstTiks=objsc.getElementsByTagName("TasaCambios");var obj=lstTiks[0];var dblTC=obj.getAttribute("TC");var strOperacion=obj.getAttribute("Operacion");document.getElementById("COB_OPERACION").value=strOperacion;if(dblTC==0){dblTC=1;}document.getElementById("TASA_CAMBIO_PAGO").value=dblTC;},error:function(objeto,quepaso,otroobj){alert(":ptoExist:"+objeto+" "+quepaso+" "+otroobj);$("#dialogWait").dialog("close");}});}function RecalculaGridNuevaTasaCambio(){var Sichecked=document.getElementById("COB_ESANTICIPO1").checked;var boolHaceOperacion=true;var dblTasaCambio=document.getElementById("TASA_CAMBIO_PAGO").value;var strOperacion=document.getElementById("COB_OPERACION").value;if(strOperacion=="M"){dblTasaCambio=1/dblTasaCambio;}if(Sichecked){}else{if(d.getElementById("COB_BCO").value==0){boolHaceOperacion=false;alert("Te falta seleccionar el banco");}}if(boolHaceOperacion){itemIdCob=0;var strCte=d.getElementById("COB_CTE").value;var strFecha1=d.getElementById("COB_FECHAS1").value;var strFecha2=d.getElementById("COB_FECHAS2").value;var strMoneda=d.getElementById("COB_MONEDA").value;var strPOST="&TKT_ANULADA=0&TKT_ESRECU=999&TKT_MONEDA="+strMoneda;if(strFecha1!=""){strPOST+="&TKT_FECHA1="+strFecha1;}if(strFecha2==""){strFecha2=FechaActualCob();}strPOST+="&TKT_FECHA2="+strFecha2;ValidaClean("COB_CTE");if(strCte==0){ValidaShow("COB_CTE","NECESITA SELECCIONAR UN CLIENTE");}else{$("#dialogWait").dialog("open");strPOST+="&CT_ID="+strCte;resetCobroMas(false);$.ajax({type:"POST",data:strPOST,scriptCharset:"utf-8",contentType:"application/x-www-form-urlencoded;charset=utf-8",cache:false,dataType:"xml",url:"ERP_Cobros.jsp?id=16",success:function(datos){var objsc=datos.getElementsByTagName("tickets")[0];var lstTiks=objsc.getElementsByTagName("ticket");for(i=0;i<lstTiks.length;i++){var obj=lstTiks[i];if(obj.getAttribute("TKT_SALDO")>0){var dblPagos=obj.getAttribute("TKT_TOTAL")-obj.getAttribute("TKT_SALDO");var strFecha=obj.getAttribute("TKT_FECHA");strFecha=strFecha.substr(strFecha.length-2,strFecha.length)+"/"+strFecha.substr(4,2)+"/"+strFecha.substr(0,4);var datarow={COBD_ID:obj.getAttribute("TKT_ID"),COBD_FOLIO:obj.getAttribute("TKT_FOLIO"),COBD_FECHA:strFecha,COBD_TOTAL:obj.getAttribute("TKT_TOTAL"),COBD_PAGOS:dblPagos,COBD_SALDO:obj.getAttribute("TKT_SALDO"),COBD_SALDO_CAMBIO:(parseFloat(obj.getAttribute("TKT_SALDO"))*parseFloat(dblTasaCambio)),COBD_TIPO:"TICKET"};itemIdCob++;jQuery("#COB_GRID1").addRowData(itemIdCob,datarow,"last");}}var objsc=datos.getElementsByTagName("facturas")[0];var lstTiks=objsc.getElementsByTagName("factura");for(i=0;i<lstTiks.length;i++){var obj=lstTiks[i];if(obj.getAttribute("FAC_SALDO")>0){var dblPagos=obj.getAttribute("FAC_TOTAL")-obj.getAttribute("FAC_SALDO");var strFecha=obj.getAttribute("FAC_FECHA");var dblSaldoCambio=parseFloat(obj.getAttribute("FAC_SALDO"))*parseFloat(dblTasaCambio);strFecha=strFecha.substr(strFecha.length-2,strFecha.length)+"/"+strFecha.substr(4,2)+"/"+strFecha.substr(0,4);var datarow={COBD_ID:obj.getAttribute("FAC_ID"),COBD_FOLIO:obj.getAttribute("FAC_FOLIO"),COBD_FECHA:strFecha,COBD_TOTAL:obj.getAttribute("FAC_TOTAL"),COBD_PAGOS:dblPagos,COBD_SALDO:obj.getAttribute("FAC_SALDO"),COBD_SALDO_CAMBIO:dblSaldoCambio,COBD_TIPO:"FACTURA"};itemIdCob++;jQuery("#COB_GRID1").addRowData(itemIdCob,datarow,"last");}}document.getElementById("ANTICIPO_USO").value=document.getElementById("ANTICIPO_TOTAL").value;document.getElementById("COB_FALTA_MAX").value=document.getElementById("COB_MAX_PAGO").value;$("#dialogWait").dialog("close");},error:function(objeto,quepaso,otroobj){alert(":ptoExist:"+objeto+" "+quepaso+" "+otroobj);$("#dialogWait").dialog("close");}});}}else{d.getElementById("COB_MONEDA").focus();}}function ObtenNomCteAntCobros(){var strCT_ID=document.getElementById("COB_CTE").value;var strPOST="&CTE_ID="+strCT_ID;$("#dialogWait").dialog("open");$.ajax({type:"POST",data:strPOST,scriptCharset:"utf-8",contentType:"application/x-www-form-urlencoded;charset=utf-8",cache:false,dataType:"html",url:"ERP_Cobros.jsp?id=6",success:function(datos){if(trim(datos)){var info=datos.split("|");document.getElementById("COB_NOM_CTE").value=info[0];$("#dialogWait").dialog("close");}else{$("#dialogWait").dialog("close");}},error:function(objeto,quepaso,otroobj){alert(":ptoExist:"+objeto+" "+quepaso+" "+otroobj);
$("#dialogWait").dialog("close");}});}function AddTrxEvtMas(event,obj){if(event.keyCode==13){getTrxMas(obj);}}function AddTrxIndMas(){getTrxMas(d.getElementById("COB_TRX"));}function getTrxMas(obj){var strPrefijoMaster="TKT";var strNomDoc="TICKET";strNomOrderCob="TKT_ID";strNomFormCob="TICKETVIEW";strKeyCob="TKT_ID";strTipoVtaCob="2";var strXmlIni="vta_ticketss";if(document.getElementById("COB_TIPO").value=="1"){strPrefijoMaster="FAC";strNomFormCob="FACTVIE";strNomOrderCob="FAC_ID";strKeyCob="FAC_FOLIO_C";strTipoVtaCob="1";strXmlIni="vta_facturass";strNomDoc="FACTURA";}if(document.getElementById("COB_TIPO").value=="3"){strPrefijoMaster="PD";strNomFormCob="PEDIDOVIEW";strNomOrderCob="PD_ID";strKeyCob="PD_ID";strTipoVtaCob="3";strXmlIni="vta_pedidoss";strNomDoc="PEDIDO";}$.ajax({type:"POST",data:strPrefijoMaster+"_FOLIO_C="+obj.value+"&"+strPrefijoMaster+"_ANULADA=999&EMP_ID="+intEMP_ID,scriptCharset:"utf-8",contentType:"application/x-www-form-urlencoded;charset=utf-8",cache:false,dataType:"xml",url:"CIP_TablaOp.jsp?ID=2&opnOpt="+strNomFormCob,success:function(datoVal){var objXML=datoVal.getElementsByTagName(strXmlIni)[0];if(objXML!=null){if(objXML.getAttribute(strPrefijoMaster+"_ANULADA")==0){if(parseFloat(objXML.getAttribute(strPrefijoMaster+"_SALDO"))>0){d.getElementById("COB_NOM").value=objXML.getAttribute(strPrefijoMaster+"_RAZONSOCIAL");d.getElementById("COB_FOLIO").value=objXML.getAttribute(strPrefijoMaster+"_FOLIO_C");d.getElementById("COB_IDPAGO").value=objXML.getAttribute(strPrefijoMaster+"_ID");d.getElementById("COB_TOTTRX").value=parseFloat(FormatNumber(objXML.getAttribute(strPrefijoMaster+"_SALDO"),intNumdecimal,true));d.getElementById("FPago1").value=0;}else{alert("El documento ya no tiene saldo por pagar....");}}else{alert("EL "+strNomDoc+" "+obj.value+" con folio "+objXML.getAttribute(strPrefijoMaster+"_FOLIO")+" ESTA ANULADO");}}else{alert("EL "+strNomDoc+" "+obj.value+" NO EXISTE");}},error:function(objeto,quepaso,otroobj){alert(":ptoExist:"+objeto+" "+quepaso+" "+otroobj);$("#dialogWait").dialog("close");}});d.getElementById("COB_TRX").focus();d.getElementById("COB_TRX").select();}function AgregarPagoMasivoGridCob(){var intTipoDocIdx=document.getElementById("COB_TIPO").selectedIndex;var dblMontoPago=document.getElementById("COB_TOTTRX").value;var intIdPago=document.getElementById("COB_IDPAGO").value;if(parseFloat(intIdPago)>0){var txtTipoDoc=d.getElementById("COB_TIPO").options[intTipoDocIdx].text;var datarow={COBG_DOC_ID:intIdPago,COBG_TIPO_DOCUMENTO:document.getElementById("COB_TIPO").value,COBG_TIPO_DOC_TXT:txtTipoDoc,COBG_MONEDA:"1",COBG_MONTOPAGO:dblMontoPago,COBG_FOLIO:document.getElementById("COB_FOLIO").value,COBG_CLIENTE:document.getElementById("COB_NOM").value};jQuery("#COB_GRID_PAGOS").addRowData(document.getElementById("COB_TRX").value,datarow,"last");var grid=jQuery("#COB_GRID_PAGOS");var arr=grid.getDataIDs();var dblSuma=0;for(var i=0;i<arr.length;i++){var id=arr[i];var lstRow=grid.getRowData(id);dblSuma=dblSuma+parseFloat(lstRow.COBG_MONTOPAGO);}d.getElementById("COB_TOTAL").value=dblSuma;document.getElementById("COB_TOTTRX").value=0;document.getElementById("COB_IDPAGO").value=0;document.getElementById("COB_FOLIO").value="";document.getElementById("COB_NOM").value="";document.getElementById("COB_TRX").value="";}else{alert("Favor de seleccionar un pago");}}function RemovePagoMasivo(){var grid=jQuery("#COB_GRID_PAGOS");if(grid.getGridParam("selrow")!=null){var lstRow=grid.getRowData(grid.getGridParam("selrow"));d.getElementById("COB_TOTAL").value=parseFloat(d.getElementById("COB_TOTAL").value)-parseFloat(lstRow.COBG_MONTOPAGO);grid.delRowData(grid.getGridParam("selrow"));}}function SaveCobMas(){var $tabs=$("#tabsCOBROS").tabs();var selected=$tabs.tabs("option","active");if(selected==0){var boolValidacion=true;if(d.getElementById("CON_BANDERAIPARC")!=null){if(d.getElementById("CON_BANDERAIPARC").value==1){if(d.getElementById("COB_BANCO_MAS").value==0){alert("Seleccione el Banco");boolValidacion=false;}if(d.getElementById("COB_FECHATRX").value==""){alert("Capture la fecha");boolValidacion=false;}}}if(boolValidacion==true){$("#dialogWait").dialog("open");var grid=jQuery("#COB_GRID_PAGOS");var arr=grid.getDataIDs();var strPOST="";strPOST+="&MONEDAAPAGAR=1";strPOST+="&MONTOPAGOTOTAL="+(d.getElementById("COB_TOTAL").value);strPOST+="&BC_ID="+(d.getElementById("COB_BANCO_MAS").value);strPOST+="&ANTICIPOAUSAR=0";strPOST+="&USA_ANTI=0";strPOST+="&ANTI_ID=0";strPOST+="&CANTIDAD_ANTI=0";strPOST+="&FECHA="+(d.getElementById("COB_FECHATRX").value);strPOST+="&NOTAS=";strPOST+="&MONEDA=1";strPOST+="&TASAPESO=1.0";for(var i=0;i<arr.length;i++){var id=arr[i];var lstRow=grid.getRowData(id);if(lstRow.COBG_MONTOPAGO>0){strPOST+="&idTrx="+lstRow.COBG_DOC_ID;strPOST+="&TipoDoc="+lstRow.COBG_TIPO_DOCUMENTO;strPOST+="&MONTOPAGO="+lstRow.COBG_MONTOPAGO;strPOST+="&MONENDAORIGINAL="+lstRow.COBG_MONTOPAGO;}}var strNomForm="COBROSMAS";var strNomField="MCM_ID";strPOST+="&COUNT_PAGOS=1";strPOST+="&MCD_MONEDA1=1";strPOST+="&MCD_FOLIO1=";switch(parseInt(d.getElementById("COB_METPAGO2").value)){case 1:strPOST+="&MCD_FORMAPAGO1=EFECTIVO";strPOST+="&MCD_NOCHEQUE1=";break;case 2:strPOST+="&MCD_FORMAPAGO1=CHEQUE";strPOST+="&MCD_NOCHEQUE1="+d.getElementById("COB_NOCHEQUE").value;break;case 3:strPOST+="&MCD_FORMAPAGO1=TCREDITO";strPOST+="&MCD_NOCHEQUE1=";break;case 4:strPOST+="&MCD_FORMAPAGO1=SALDOFAVOR";strPOST+="&MCD_NOCHEQUE1=";break;case 5:strPOST+="&MCD_FORMAPAGO1=TRANSFERENCIA BANCARIA";strPOST+="&MCD_NOCHEQUE1=";break;}strPOST+="&MCD_BANCO1="+d.getElementById("COB_BANCO_MAS").value;strPOST+="&MCD_NOTARJETA1=";strPOST+="&MCD_TIPOTARJETA1=";strPOST+="&MCD_IMPORTE1="+(parseFloat(d.getElementById("COB_TOTTRX").value));strPOST+="&MCD_TASAPESO1=1";strPOST+="&MCD_CAMBIO1=0.0";strPOST+="&COUNT_PAGOS=1";strPOST+="&MCD_MONEDA1=1";strPOST+="&MCD_FOLIO1=";switch(parseInt(d.getElementById("COB_METPAGO2").value)){case 1:strPOST+="&MCD_FORMAPAGO1=EFECTIVO";strPOST+="&MCD_NOCHEQUE1=";break;case 2:strPOST+="&MCD_FORMAPAGO1=CHEQUE";strPOST+="&MCD_NOCHEQUE1="+d.getElementById("COB_NOCHEQUE").value;break;case 3:strPOST+="&MCD_FORMAPAGO1=TCREDITO";strPOST+="&MCD_NOCHEQUE1=";break;case 4:strPOST+="&MCD_FORMAPAGO1=SALDOFAVOR";strPOST+="&MCD_NOCHEQUE1=";break;case 5:strPOST+="&MCD_FORMAPAGO1=TRANSFERENCIA BANCARIA";strPOST+="&MCD_NOCHEQUE1=";break;}strPOST+="&MCD_BANCO1="+d.getElementById("COB_BANCO_MAS").value;strPOST+="&MCD_NOTARJETA1=";strPOST+="&MCD_TIPOTARJETA1=";strPOST+="&MCD_IMPORTE1="+(parseFloat(d.getElementById("COB_TOTTRX").value));strPOST+="&MCD_TASAPESO1=1";strPOST+="&MCD_CAMBIO1=0.0";$.ajax({type:"POST",data:encodeURI(strPOST),scriptCharset:"utf-8",contentType:"application/x-www-form-urlencoded;charset=utf-8",cache:false,dataType:"html",url:"Cobros.do?id=3",success:function(dato){dato=trim(dato);if(Left(dato,3)=="OK."){openFormat(strNomForm,"PDF",CreaHidden(strNomField,dato.replace("OK.","")));jQuery("#COB_GRID_PAGOS").clearGridData();document.getElementById("COB_TRX").value="";document.getElementById("COB_FECHATRX").value="";document.getElementById("COB_NOM").value="";document.getElementById("COB_FOLIO").value="";document.getElementById("COB_TOTTRX").value="0.0";document.getElementById("COB_TOTAL").value="0.0";grid.clearGridData();itemIdCob=0;$("#dialogPagos").dialog("close");}else{alert(dato);}resetCobroInd();$("#dialogWait").dialog("close");},error:function(objeto,quepaso,otroobj){alert(":pto9:"+objeto+" "+quepaso+" "+otroobj);$("#dialogWait").dialog("close");}});}}else{SaveCob();}}function InitCobMasivos1(){$("#dialogWait").dialog("open");myLayout.close("west");myLayout.close("east");myLayout.close("south");myLayout.close("north");d.getElementById("COB_TRX").focus();d.getElementById("COB_TRX").select();var strHtml="<ul>"+getMenuItem("SaveCobMas();","Guardar Cobro Masivo","images/ptovta/CircleSave.png")+getMenuItem("SalirCob();","Salir","images/ptovta/exitBig.png")+"</ul>";document.getElementById("TOOLBAR").innerHTML=strHtml;document.getElementById("COB_MONEDA_PAGO").disabled=true;
document.getElementById("COB_FALTA_MAX").disabled=true;document.getElementById("ANTICIPO_TOTAL").disabled=true;document.getElementById("COB_NOM_CTE").disabled=true;document.getElementById("COB_NOCHEQUE").parentNode.parentNode.style.display="none";EsAnticipoCob();document.getElementById("TASA_CAMBIO_PAGO").disabled=true;document.getElementById("btn1").style.display="none";itemIdCob=0;$("#dialogWait").dialog("close");}