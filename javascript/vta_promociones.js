function vta_promociones(){}var objPromos=null;var lstVars;var lstOfertasActivas;var _debugPromos=false;var _intContaOfertas=-1;var _countTimePromoLoadJsLib=0;var _bolPromoAplicaSuma=true;var _urlPromoMotor="Promociones.do";var _urlImg1="images/ptovta/gift_box1.png";function _InitPromociones(){bolSaveVta=true;$("#dialogWait2").dialog("open");$.ajax({type:"POST",data:"",scriptCharset:"utf-8",contentType:"application/x-www-form-urlencoded;charset=utf-8",cache:false,dataType:"xml",url:_urlPromoMotor+"?id=1",success:function(datoVal){objPromos=datoVal.getElementsByTagName("promociones")[0];lstVars=null;lstOfertasActivas=null;bolCargaPromociones=true;_intContaOfertas=-1;$("#dialogWait2").dialog("close");},error:function(objeto,quepaso,otroobj){$("#dialogWait2").dialog("close");alert(":promo ini:"+objeto+" "+quepaso+" "+otroobj);}});}function _InitPromocionesEcomm(){bolSaveVta=true;$("#dialogWait2").dialog("open");_urlPromoMotor="../Promociones.do";_urlImg1="../images/ptovta/gift_box1.png";$.ajax({type:"POST",data:"",scriptCharset:"utf-8",contentType:"application/x-www-form-urlencoded;charset=utf-8",cache:false,dataType:"xml",url:_urlPromoMotor+"?id=1",success:function(datoVal){objPromos=datoVal.getElementsByTagName("promociones")[0];lstVars=null;lstOfertasActivas=null;bolCargaPromociones=true;_intContaOfertas=-1;setTimeout("_CargaVarsCte();",1000);$("#dialogWait2").dialog("close");},error:function(objeto,quepaso,otroobj){$("#dialogWait2").dialog("close");alert(":promo ini:"+objeto+" "+quepaso+" "+otroobj);}});}function _InitVars(){bolSaveVta=true;if(lstVars==null){lstVars=Array();if(_debugPromos){_LogPromos("Iniciamos arreglo....");}var intContaPromos=-1;var _lstPromo=objPromos.getElementsByTagName("promocion");for(var h=0;h<_lstPromo.length;h++){var objPromo=_lstPromo[h];var objVariables=objPromo.getElementsByTagName("variables")[0];var _lstVariables=objVariables.getElementsByTagName("variable");if(_debugPromos){_LogPromos(objPromo.getAttribute("PROM_NOMBRE")+"_lstVariables:"+_lstVariables.length);}for(var i=0;i<_lstVariables.length;i++){intContaPromos++;var _objVariable=new _ClassVariable();_objVariable.intId=_lstVariables[i].getAttribute("PVAR_ID");_objVariable.strNombre=_lstVariables[i].getAttribute("PVAR_VARIABLE");_objVariable.intTipo=_lstVariables[i].getAttribute("PVAR_TIPO");_objVariable.intSec=_lstVariables[i].getAttribute("PVAR_SQL_CTE_PROD");_objVariable.intPromoId=objPromo.getAttribute("PROM_ID");_objVariable.strTipoDato=_lstVariables[i].getAttribute("PVAR_DATO");_objVariable.strScript=_lstVariables[i].getAttribute("PVAR_SCRIPT");lstVars[intContaPromos]=_objVariable;}}}}function _CargaVarsCte(){_InitVars();if(_debugPromos){_LogPromos("Carga de variables del cliente....");}var strLstCteVarsPost="";var strLstCteVarsPostKeys="";var strLstCteVarsPostProm="";for(var k=0;k<lstVars.length;k++){var objVar=lstVars[k];if(objVar.intSec==1){if(_debugPromos){_LogPromos(objVar.strNombre);}strLstCteVarsPostKeys+=objVar.intId+",";strLstCteVarsPost+=objVar.strNombre+",";strLstCteVarsPostProm+=objVar.intPromoId+",";}}if(strLstCteVarsPost!=""){var strPost="CT_ID="+document.getElementById("FCT_ID").value;strPost+="&SC_ID="+document.getElementById("SC_ID").value;strPost+="&VARS_ID="+strLstCteVarsPostKeys;strPost+="&VARS_VAR="+strLstCteVarsPost;strPost+="&VARS_PROM="+strLstCteVarsPostProm;$("#dialogWait2").dialog("open");$.ajax({type:"POST",data:strPost,scriptCharset:"utf-8",contentType:"application/x-www-form-urlencoded;charset=utf-8",cache:false,dataType:"xml",url:_urlPromoMotor+"?id=2",success:function(datoVal){var objVariables=datoVal.getElementsByTagName("variables")[0];var _lstVariable=objVariables.getElementsByTagName("variable");for(var h=0;h<_lstVariable.length;h++){var objVariable=_lstVariable[h];for(var k=0;k<lstVars.length;k++){var objVar=lstVars[k];if(objVar.intSec==1&&objVar.intId==objVariable.getAttribute("var_id")&&objVar.intPromoId==objVariable.getAttribute("promo_id")){_AsignaVars(objVar,objVariable);}}}$("#dialogWait2").dialog("close");_CargaCalculaFormulas(1);},error:function(objeto,quepaso,otroobj){$("#dialogWait2").dialog("close");alert(":promo load cte:"+objeto+" "+quepaso+" "+otroobj);}});}}function _CargaVarsProd(lstRow){_InitVars();if(_debugPromos){_LogPromos("Carga de variables del producto....");}var strLstCteVarsPost="";var strLstCteVarsPostKeys="";var strLstCteVarsPostProm="";for(var i=0;i<lstVars.length;i++){var objVar=lstVars[i];if(objVar.intSec==2){if(objVar.strNombre.indexOf("$cumpleClas")!=-1){if(!objVar.boolValor){if(_debugPromos){_LogPromos(objVar.strNombre+"Valida clasificaciones...");}var strNomClas=objVar.strNombre.replace("$cumpleClas","");for(var iClas=1;iClas<=10;iClas++){if(strNomClas.indexOf(iClas+"Prod(")!=-1){strNomClas=strNomClas.replace(iClas+"Prod(","");strNomClas=strNomClas.replace(")","");try{var _intValorClasRow=0;if(iClas==1){_intValorClasRow=parseInt(lstRow.FACD_PR_CAT1);}if(iClas==2){_intValorClasRow=parseInt(lstRow.FACD_PR_CAT2);}if(iClas==3){_intValorClasRow=parseInt(lstRow.FACD_PR_CAT3);}if(iClas==4){_intValorClasRow=parseInt(lstRow.FACD_PR_CAT4);}if(iClas==5){_intValorClasRow=parseInt(lstRow.FACD_PR_CAT5);}if(iClas==6){_intValorClasRow=parseInt(lstRow.FACD_PR_CAT6);}if(iClas==7){_intValorClasRow=parseInt(lstRow.FACD_PR_CAT7);}if(iClas==8){_intValorClasRow=parseInt(lstRow.FACD_PR_CAT8);}if(iClas==9){_intValorClasRow=parseInt(lstRow.FACD_PR_CAT9);}if(iClas==10){_intValorClasRow=parseInt(lstRow.FACD_PR_CAT10);}if(_debugPromos){_LogPromos(strNomClas+"vs "+_intValorClasRow);}if(parseInt(strNomClas)==_intValorClasRow){objVar.boolValor=true;}}catch(err){alert(err);}}}if(_debugPromos){_LogPromos("Cumple clas:"+objVar.boolValor);}}}else{if(objVar.strNombre.indexOf("$codigoProducto(")!=-1){if(!objVar.boolValor){if(_debugPromos){_LogPromos(objVar.strNombre+"Buscamos producto...");}var strNvaLstProdFind=objVar.strNombre.replace("$codigoProducto(","");strNvaLstProdFind=strNvaLstProdFind.replace(")","");strNvaLstProdFind=strNvaLstProdFind.replace(/"/g,"");var bolCumple=false;if(strNvaLstProdFind!=""){var _lstRecCve=strNvaLstProdFind.split(",");for(var km=0;km<_lstRecCve.length;km++){if(_debugPromos){_LogPromos("buscando producto "+_lstRecCve[km]+" vs "+lstRow.FACD_CVE);}if(trim(_lstRecCve[km])==trim(lstRow.FACD_CVE)){bolCumple=true;}}objVar.boolValor=bolCumple;}}}else{if(_debugPromos){_LogPromos(objVar.strNombre);}strLstCteVarsPostKeys+=objVar.intId+",";strLstCteVarsPost+=objVar.strNombre+",";strLstCteVarsPostProm+=objVar.intPromoId+",";}}}}if(strLstCteVarsPost!=""){var strPost="CT_ID="+document.getElementById("FCT_ID").value;strPost+="&SC_ID="+document.getElementById("SC_ID").value;strPost+="&PR_ID="+lstRow.FACD_PR_ID;strPost+="&VARS_ID="+strLstCteVarsPostKeys;strPost+="&VARS_VAR="+strLstCteVarsPost;strPost+="&VARS_PROM="+strLstCteVarsPostProm;$("#dialogWait2").dialog("open");$.ajax({type:"POST",data:strPost,scriptCharset:"utf-8",contentType:"application/x-www-form-urlencoded;charset=utf-8",cache:false,dataType:"xml",url:_urlPromoMotor+"?id=3",success:function(datoVal){var objVariables=datoVal.getElementsByTagName("variables")[0];var _lstVariable=objVariables.getElementsByTagName("variable");for(var h=0;h<_lstVariable.length;h++){var objVariable=_lstVariable[h];for(var k=0;k<lstVars.length;k++){var objVar=lstVars[k];if(objVar.intSec==2&&objVar.intId==objVariable.getAttribute("var_id")&&objVar.intPromoId==objVariable.getAttribute("promo_id")){_AsignaVars(objVar,objVariable);}}}$("#dialogWait2").dialog("close");},error:function(objeto,quepaso,otroobj){$("#dialogWait2").dialog("close");alert(":promo ini:"+objeto+" "+quepaso+" "+otroobj);}});}}function _AsignaVars(objVar,objVariable){_AsignaVarsValor(objVar,objVariable.getAttribute("var_valor"));}function _AsignaVarsValor(objVar,strValor){if(objVar.strTipoDato=="text"){objVar.strValor=strValor;}if(objVar.strTipoDato=="date"){objVar.dateValor=strValor;}if(objVar.strTipoDato=="boolean"){if(strValor=="true"){objVar.boolValor=true;}}if(objVar.strTipoDato=="integer"){try{objVar.intValor=parseInt(strValor);
}catch(err){alert("Error al convertir numerico en variable "+objVar.intId+" de la promocion "+objVar.intPromoId+err);}}if(objVar.strTipoDato=="double"){try{objVar.dblValor=parseFloat(strValor);}catch(err){alert("Error al convertir numerico en variable "+objVar.intId+" de la promocion "+objVar.intPromoId+err);}}}function _CargaVarsTot(strNomScript){_InitVars();if(_debugPromos){_LogPromos("Carga de variables sobre totales....");}for(var i=0;i<lstVars.length;i++){var objVar=lstVars[i];if(objVar.intSec==3){if(objVar.strScript.indexOf("$get(")!=-1){var strNomCampo=objVar.strScript.replace("$get(","");strNomCampo=strNomCampo.replace(")","");strNomCampo=strNomCampo.replace(/"/g,"");var strValorR=_VarsGetElement(strNomCampo);_AsignaVarsValor(objVar,strValorR);if(_debugPromos){_LogPromos(objVar.strNombre+" "+objVar.strValor);}}if(objVar.strScript.indexOf("$func(")!=-1){var strParam1=objVar.strNombre.replace("$cuantasPiezas(","");strParam1=strParam1.replace(")","");if(strParam1==""){strParam1="null";}var strNomFxs=objVar.strScript.replace("$func(","");strNomFxs=strNomFxs.replace(")","");strNomFxs="_"+strNomFxs.replace(/"/g,"")+"("+i+","+strParam1+")";if(_debugPromos){_LogPromos("Function execute "+strNomFxs);}try{setTimeout(strNomFxs+";",1);}catch(err){var txt="There was an error when call function "+strNomFxs+" .\n\n";txt+="Error description: "+err.description+" \n\n";txt+="Click OK to continue.\n\n";alert(txt);}}}}setTimeout(strNomScript,10);}function _VarsGetElement(strNomCampo){if(_debugPromos){_LogPromos("Obtener campo "+strNomCampo);}var strValor="";try{strValor=document.getElementById(strNomCampo).value;}catch(err){alert("El campo "+strNomCampo+" no existe");}return strValor;}function _ResetVarsProd(){_InitVars();if(_debugPromos){_LogPromos("Reseteamos las promociones producto....");}for(var i=0;i<lstVars.length;i++){var objVar=lstVars[i];if(objVar.intTipo==2||objVar.intTipo==3){objVar.dblValor=0;objVar.intValor=0;objVar.strValor="";objVar.boolValor=false;objVar.dateValor=null;}}}function _ResetVarsAll(){_InitVars();if(_debugPromos){_LogPromos("Reseteamos TODAS las promociones....");}for(var i=0;i<lstVars.length;i++){var objVar=lstVars[i];objVar.dblValor=0;objVar.intValor=0;objVar.strValor="";objVar.boolValor=false;objVar.dateValor=null;}lstOfertasActivas=null;_intContaOfertas=-1;_drawOfertas();var objCte=document.getElementById("FCT_ID");objCte.setAttribute("class","outEdit");objCte.setAttribute("className","outEdit");objCte.readOnly=false;objCte.disabled=false;}function _CargaCalculaFormulas(intFase){if(_debugPromos){_LogPromos("Vamos a calcular las formulas....");}$("#dialogWaitProm").dialog("open");_ResetAplicaOfertas(intFase);var bolAplicaPromo=false;var _lstPromo=objPromos.getElementsByTagName("promocion");for(var h=0;h<_lstPromo.length;h++){var objPromo=_lstPromo[h];if(objPromo.getAttribute("PROM_FASE")==intFase){bolAplicaPromo=true;var strFormulaAplica=objPromo.getAttribute("PROM_FORMULA");if(_debugPromos){_LogPromos("(1)strFormulaAplica:"+strFormulaAplica);}strFormulaAplica=strFormulaAplica.replace(/ y /g," && ");strFormulaAplica=strFormulaAplica.replace(/ o /g," || ");strFormulaAplica=strFormulaAplica.replace("$Hoy",strHoyFecha);for(var i=0;i<lstVars.length;i++){var objVar=lstVars[i];if(parseInt(objVar.intPromoId)==parseInt(objPromo.getAttribute("PROM_ID"))){var strValor=objVar.strValor;if(objVar.strTipoDato=="boolean"){strValor=objVar.boolValor;}if(objVar.strTipoDato=="integer"){strValor=objVar.intValor;}if(objVar.strTipoDato=="double"){strValor=objVar.dblValor;}if(objVar.strTipoDato=="date"){strValor=objVar.dateValor;}while(strFormulaAplica.indexOf(objVar.strNombre)!=-1){strFormulaAplica=strFormulaAplica.replace(objVar.strNombre,strValor);}}}var bolPasaPromo=false;strFormulaAplica="if("+strFormulaAplica+")bolPasaPromo=true;";try{eval(strFormulaAplica);}catch(error){alert("Error al ejecutar la formula:"+error);}if(_debugPromos){_LogPromos("(3)strFormulaAplica:"+strFormulaAplica+" "+bolPasaPromo);}if(bolPasaPromo){if(lstOfertasActivas==null){lstOfertasActivas=Array();}var objOferta=new _ClassOferta();objOferta.intIdOferta=objPromo.getAttribute("PROM_ID");objOferta.strNombre=objPromo.getAttribute("PROM_NOMBRE");objOferta.strDesc=objPromo.getAttribute("PROM_DESCRIPCION");_intContaOfertas++;lstOfertasActivas[_intContaOfertas]=objOferta;}}}if(bolAplicaPromo){_drawOfertas();_AplicaOfertas();}else{$("#dialogWaitProm").dialog("close");}}function _drawOfertas(){if(lstOfertasActivas!=null){var objCte=document.getElementById("FCT_ID");objCte.setAttribute("class","READONLY");objCte.setAttribute("className","READONLY");objCte.readOnly=true;objCte.disabled=true;var strHMTL="<div id='Ofertas_activas'><img src='"+_urlImg1+"' border='0' id='OfertasGift1' /></br>";var strLstOfActivas="";for(var i=0;i<lstOfertasActivas.length;i++){var objOferta=lstOfertasActivas[i];strHMTL+="<div id='Oferta'>";strHMTL+=objOferta.strNombre;strHMTL+="&nbsp;<span class= 'Desc_promo'>";strHMTL+=objOferta.strDesc;strHMTL+="</span>";strHMTL+="</div>";strLstOfActivas+=objOferta.intIdOferta+",";}var strHMTL2="<div id='Ofertas_activas_list'>"+lstMsg[160]+"</div>"+strHMTL;strHMTL+="<input type='button' name='aplica_oferta' id='aplica_oferta' value='Continuar' onClick='_CierraDrawOfertas();'>";strHMTL2+="<input type='hidden' name='lst_ofertas' id='lst_ofertas' value='"+strLstOfActivas+"' >";strHMTL+="</div>";strHMTL2+="</div>";document.getElementById("PROMOS_LST").innerHTML=strHMTL2;}else{document.getElementById("PROMOS_LST").innerHTML="&nbsp;";}}function _CierraDrawOfertas(){$("#dialogPromociones").dialog("close");}function _ClassVariable(){this.intId=0;this.strNombre="";this.strValor="";this.dblValor=0;this.intValor=0;this.dateValor=null;this.boolValor=false;this.intTipo=1;this.intSec=1;this.intPromoId=0;this.strTipoDato="";this.strScript="";}function _ClassOferta(){this.intIdOferta=0;this.strNombre="";this.strDesc="";}function _LogPromos(strMsg){if(navigator.userAgent.indexOf("Firefox")){console.log(strMsg);}else{alert(strMsg);}}function _ConteoPzasLista(idVar,lstSKUs){if(_debugPromos){_LogPromos("Conteo de Pzas "+idVar+" "+lstSKUs);}var _lstSkus=lstSKUs.split(",");if(typeof(bolEcommPromos)=="undefined"){bolEcommPromos=false;}if(_debugPromos){}if(bolEcommPromos){var dblSuma=0;for(var j=0;j<=intContaItems;j++){var objItem=lstItems[j];for(var km=0;km<_lstSkus.length;km++){if(trim(_lstSkus[km])==trim(objItem.pr_codigo)){dblSuma+=parseFloat(objItem.pr_cantidad);}}}}else{var grid=jQuery("#FAC_GRID");var arr=grid.getDataIDs();var dblSuma=0;for(var i=0;i<arr.length;i++){var id=arr[i];var lstRow=grid.getRowData(id);for(var km=0;km<_lstSkus.length;km++){if(trim(_lstSkus[km])==trim(lstRow.FACD_CVE)){dblSuma+=parseFloat(lstRow.FACD_CANTIDAD);}}}}var objVar=lstVars[idVar];_AsignaVarsValor(objVar,dblSuma);}function _AplicaOfertas(){if(lstOfertasActivas!=null){for(var i=0;i<lstOfertasActivas.length;i++){var objOferta=lstOfertasActivas[i];var _lstPromo=objPromos.getElementsByTagName("promocion");for(var h=0;h<_lstPromo.length;h++){var objPromo=_lstPromo[h];if(parseInt(objOferta.intIdOferta)==parseInt(objPromo.getAttribute("PROM_ID"))){var objConsecuentes=objPromo.getElementsByTagName("consecuentes")[0];var _lstConsecuentes=objConsecuentes.getElementsByTagName("consecuente");if(_debugPromos){_LogPromos(objPromo.getAttribute("PROM_NOMBRE")+"_lstConsecuentes:"+_lstConsecuentes.length);}for(var k=0;k<_lstConsecuentes.length;k++){var objConsecuente=_lstConsecuentes[k];if(parseInt(objConsecuente.getAttribute("PCO_TIPO"))==1){_AplicaDescGlobal(objOferta.intIdOferta,objConsecuente.getAttribute("PCO_DESC"),objConsecuente.getAttribute("PCO_AP_DESC_IMPORTE"),objConsecuente.getAttribute("PCO_AP_DESC_PTO"),objConsecuente.getAttribute("PCO_AP_DESC_VN"),objConsecuente.getAttribute("PCO_AP_DESC_LEAL"));}if(parseInt(objConsecuente.getAttribute("PCO_TIPO"))==3){_AplicaDescListado(objOferta.intIdOferta,objConsecuente.getAttribute("PCO_DESC"),objConsecuente.getAttribute("PCO_AP_DESC_IMPORTE"),objConsecuente.getAttribute("PCO_AP_DESC_PTO"),objConsecuente.getAttribute("PCO_AP_DESC_VN"),objConsecuente.getAttribute("PCO_AP_DESC_LEAL"),objConsecuente.getAttribute("PCO_LST_REGALO"),1);
}if(parseInt(objConsecuente.getAttribute("PCO_TIPO"))==2){_AplicaDescClasific(objOferta.intIdOferta,objConsecuente.getAttribute("PCO_DESC"),objConsecuente.getAttribute("PCO_AP_DESC_IMPORTE"),objConsecuente.getAttribute("PCO_AP_DESC_PTO"),objConsecuente.getAttribute("PCO_AP_DESC_VN"),objConsecuente.getAttribute("PCO_AP_DESC_LEAL"),objConsecuente.getAttribute("PCO_NUMCLAS_REGALO"),objConsecuente.getAttribute("PCO_CLAS_REGALO"));}if(parseInt(objConsecuente.getAttribute("PCO_TIPO"))==4){_AplicaRegalo(objOferta.intIdOferta,objConsecuente.getAttribute("PCO_LST_REGALO"),objConsecuente.getAttribute("PCO_PREC"),objConsecuente.getAttribute("PCO_PREC_PTO"),objConsecuente.getAttribute("PCO_PREC_VN"),objConsecuente.getAttribute("PCO_PREC_LEAL"),objConsecuente.getAttribute("PCO_REGA_CANTIDAD"),objPromo.getAttribute("PROM_NOMBRE"));}if(parseInt(objConsecuente.getAttribute("PCO_TIPO"))==5){_AplicaCambioLista(objOferta.intIdOferta,objConsecuente.getAttribute("PCO_LPRECIOS"));}if(parseInt(objConsecuente.getAttribute("PCO_TIPO"))==6){_AplicaStop(objOferta.intIdOferta,objConsecuente.getAttribute("PCO_MSG"));}if(parseInt(objConsecuente.getAttribute("PCO_TIPO"))==7){_AplicaMsg(objOferta.intIdOferta,objConsecuente.getAttribute("PCO_MSG"));}if(parseInt(objConsecuente.getAttribute("PCO_TIPO"))==8){_LoadLibraryScript(objOferta.intIdOferta,objConsecuente.getAttribute("PCO_MSG"),objConsecuente.getAttribute("PCO_LIBSCRIPT"));}}}}}setTimeout("_AplicaSumasTotales()",10);}else{$("#dialogWaitProm").dialog("close");}}function _AplicaSumasTotales(){if(_bolPromoAplicaSuma){$("#dialogWaitProm").dialog("close");setSum(false);}else{setTimeout("_AplicaSumasTotales()",10);}}function _AplicaDescGlobal(intIdOferta,dblDesc,intApPrec,intApPto,intApVn,intAPLeal){if(typeof(bolEcommPromos)=="undefined"){bolEcommPromos=false;}if(_debugPromos){_LogPromos("Descuento global: "+dblDesc+" "+intApPrec+" "+intApPto+" "+intApVn);}dblDesc=parseFloat(dblDesc);intApPrec=parseInt(intApPrec);intApPto=parseInt(intApPto);intApVn=parseInt(intApVn);intAPLeal=parseInt(intAPLeal);if(bolEcommPromos){_iAplicaDescGlobal(intIdOferta,dblDesc,intApPrec,intApPto,intApVn,intAPLeal);}else{var grid=jQuery("#FAC_GRID");var arr=grid.getDataIDs();for(var i=0;i<arr.length;i++){var id=arr[i];var lstRow=grid.getRowData(id);if(dblDesc>parseFloat(lstRow.FACD_PORDESC)){if(parseInt(lstRow.FACD_ID_PROMO)==0){lstRow.FACD_DESC_ORI=lstRow.FACD_PORDESC;}lstRow.FACD_PORDESC=dblDesc;lstRow.FACD_ID_PROMO=intIdOferta;if(lstRow.FACD_DESC_PREC==1){lstRow.FACD_DESC_PREC=intApPrec;}if(lstRow.FACD_DESC_PTO==1){lstRow.FACD_DESC_PTO=intApPto;}if(lstRow.FACD_DESC_VN==1){lstRow.FACD_DESC_VN=intApVn;}if(lstRow.FACD_DESC_LEAL==1){lstRow.FACD_DESC_LEAL=intAPLeal;}lstRowChangePrecio(lstRow,id,grid,false);}}}}function _AplicaDescListado(intIdOferta,dblDesc,intApPrec,intApPto,intApVn,intAPLeal,strLstCod,intNegocioZero){if(typeof(bolEcommPromos)=="undefined"){bolEcommPromos=false;}if(_debugPromos){_LogPromos("Descuento listado producto: "+dblDesc+" "+intApPrec+" "+intApPto+" "+intApVn+" "+strLstCod);}dblDesc=parseFloat(dblDesc);intApPrec=parseInt(intApPrec);intApPto=parseInt(intApPto);intApVn=parseInt(intApVn);intAPLeal=parseInt(intAPLeal);intNegocioZero=parseInt(intNegocioZero);var _lstCodDescProd=strLstCod.split(",");if(bolEcommPromos){_iAplicaDescListado(intIdOferta,dblDesc,intApPrec,intApPto,intApVn,intAPLeal,strLstCod,intNegocioZero);}else{var grid=jQuery("#FAC_GRID");var arr=grid.getDataIDs();for(var i=0;i<arr.length;i++){var id=arr[i];var lstRow=grid.getRowData(id);for(var _iCod2=0;_iCod2<_lstCodDescProd.length;_iCod2++){if(trim(_lstCodDescProd[_iCod2])==trim(lstRow.FACD_CVE)){if(dblDesc>parseFloat(lstRow.FACD_PORDESC)){if(parseInt(lstRow.FACD_ID_PROMO)==0){lstRow.FACD_DESC_ORI=lstRow.FACD_PORDESC;}lstRow.FACD_PORDESC=dblDesc;lstRow.FACD_ID_PROMO=intIdOferta;lstRow.FACD_DESC_PREC=intApPrec;lstRow.FACD_DESC_PTO=intApPto;lstRow.FACD_DESC_VN=intApVn;lstRow.FACD_DESC_LEAL=intAPLeal;if(intNegocioZero==1){lstRow.FACD_NEGO_ZERO=1;}lstRowChangePrecio(lstRow,id,grid,false);}}}}}}function _AplicaDescClasific(intIdOferta,dblDesc,intApPrec,intApPto,intApVn,intAPLeal,intIdClas,intValClas){if(_debugPromos){_LogPromos("Descuento clasificacion: "+dblDesc+" "+intApPrec+" "+intApPto+" "+intApVn+" "+intIdClas+" "+intValClas);}if(typeof(bolEcommPromos)=="undefined"){bolEcommPromos=false;}if(bolEcommPromos){_iAplicaDescClasific(intIdOferta,dblDesc,intApPrec,intApPto,intApVn,intAPLeal,intIdClas,intValClas);}else{dblDesc=parseFloat(dblDesc);intApPrec=parseInt(intApPrec);intApPto=parseInt(intApPto);intApVn=parseInt(intApVn);intAPLeal=parseInt(intAPLeal);var grid=jQuery("#FAC_GRID");var arr=grid.getDataIDs();for(var i=0;i<arr.length;i++){var id=arr[i];var lstRow=grid.getRowData(id);var intValueClas=lstRow.FACD_PR_CAT1;if(intIdClas==2){intValueClas=lstRow.FACD_PR_CAT2;}if(intIdClas==3){intValueClas=lstRow.FACD_PR_CAT3;}if(intIdClas==4){intValueClas=lstRow.FACD_PR_CAT4;}if(intIdClas==5){intValueClas=lstRow.FACD_PR_CAT5;}if(intIdClas==6){intValueClas=lstRow.FACD_PR_CAT6;}if(intIdClas==7){intValueClas=lstRow.FACD_PR_CAT7;}if(intIdClas==8){intValueClas=lstRow.FACD_PR_CAT8;}if(intIdClas==9){intValueClas=lstRow.FACD_PR_CAT9;}if(intIdClas==10){intValueClas=lstRow.FACD_PR_CAT10;}if(parseInt(intValueClas)==parseInt(intValClas)){if(dblDesc>parseFloat(lstRow.FACD_PORDESC)){if(parseInt(lstRow.FACD_ID_PROMO)==0){lstRow.FACD_DESC_ORI=lstRow.FACD_PORDESC;}lstRow.FACD_PORDESC=dblDesc;lstRow.FACD_ID_PROMO=intIdOferta;lstRow.FACD_DESC_PREC=intApPrec;lstRow.FACD_DESC_PTO=intApPto;lstRow.FACD_DESC_VN=intApVn;lstRow.FACD_DESC_LEAL=intAPLeal;lstRowChangePrecio(lstRow,id,grid,false);}}}}}function _AplicaRegalo(intIdOferta,strCod,dblPrec,dblPto,dblVN,dblLealtad,dblCantidad,strNomPromo){_bolPromoAplicaSuma=false;$("#dialogWait2").dialog("open");$.ajax({type:"POST",data:encodeURI("PR_CODIGO="+strCod+"&SC_ID="+d.getElementById("SC_ID").value),scriptCharset:"utf-8",contentType:"application/x-www-form-urlencoded;charset=utf-8",cache:false,dataType:"xml",url:"VtasMov.do?id=5",success:function(datoVal){var objProd=datoVal.getElementsByTagName("vta_productos")[0];var Pr_Id=0;if(objProd!=undefined){Pr_Id=objProd.getAttribute("PR_ID");if(Pr_Id!=0){strCod=objProd.getAttribute("PR_CODIGO");}}var Ct_Id=d.getElementById("FCT_ID").value;if(Pr_Id!=0){var dblExistencia=objProd.getAttribute("PR_EXISTENCIA");if(objProd.getAttribute("PR_REQEXIST")==1&&document.getElementById("FAC_TIPO").value!=3){$.ajax({type:"POST",data:"PR_ID="+Pr_Id,scriptCharset:"utf-8",contentType:"application/x-www-form-urlencoded;charset=utf-8",cache:false,dataType:"html",url:"InvMov.do?id=1",success:function(datoExist){dblExistencia=parseFloat(datoExist);if(parseFloat(dblCantidad)>dblExistencia){alert(lstMsg[3]+"("+dblCantidad+") "+lstMsg[34]+strCod+"("+dblExistencia+") "+lstMsg[4]);if(parseFloat(dblExistencia)>0){dblCantidad=dblExistencia;}else{dblCantidad=0;}}$("#dialogWait2").dialog("close");AddItemPrecPromo(intIdOferta,objProd,Pr_Id,Ct_Id,dblCantidad,strCod,dblExistencia,dblPrec,dblPto,dblVN,dblLealtad);},error:function(objeto,quepaso,otroobj){alert(":Promos 3:"+objeto+" "+quepaso+" "+otroobj);$("#dialogWait2").dialog("close");}});}else{$("#dialogWait2").dialog("close");AddItemPrecPromo(intIdOferta,objProd,Pr_Id,Ct_Id,dblCantidad,strCod,dblExistencia,dblPrec,dblPto,dblVN,dblLealtad);}}else{alert(lstMsg[162].replace("{promocion}",strNomPromo).replace("{codigo}",strCod));$("#dialogWait2").dialog("close");_bolPromoAplicaSuma=true;}},error:function(objeto,quepaso,otroobj){alert(":Promos 4:"+objeto+" "+quepaso+" "+otroobj);$("#dialogWait2").dialog("close");}});}function AddItemPrecPromo(intIdOferta,objProd,Pr_Id,Ct_Id,Cantidad,strCod,dblExist,dblPrec,dblPto,dblVN,dblLealtad){var objImportes=new _ImporteVta();objImportes.dblCantidad=Cantidad;var dblPrecio=dblPrec;objImportes.dblPuntos=parseFloat(dblPto);objImportes.dblVNegocio=parseFloat(dblVN);objImportes.dblPrecio=parseFloat(dblPrecio);objImportes.dblPrecioReal=parseFloat(dblPrecio);objImportes.dblPorcDescGlobal=0;
objImportes.dblExento1=objProd.getAttribute("PR_EXENTO1");objImportes.dblExento2=objProd.getAttribute("PR_EXENTO2");objImportes.dblExento3=objProd.getAttribute("PR_EXENTO3");objImportes.intDevo=0;objImportes.CalculaImporte();var dblDescuento=objImportes.dblImporteDescuento;var dblImporte=objImportes.dblImporte;var datarow={FACD_ID:0,FACD_CANTIDAD:Cantidad,FACD_DESCRIPCION:objProd.getAttribute("PR_DESCRIPCION"),FACD_IMPORTE:dblImporte,FACD_CVE:strCod,FACD_PRECIO:dblPrecio,FACD_TASAIVA1:dblTasaVta1,FACD_TASAIVA2:dblTasaVta2,FACD_TASAIVA3:dblTasaVta3,FACD_DESGLOSA1:1,FACD_IMPUESTO1:objImportes.dblImpuesto1,FACD_PR_ID:Pr_Id,FACD_EXENTO1:objProd.getAttribute("PR_EXENTO1"),FACD_EXENTO2:objProd.getAttribute("PR_EXENTO2"),FACD_EXENTO3:objProd.getAttribute("PR_EXENTO3"),FACD_REQEXIST:objProd.getAttribute("PR_REQEXIST"),FACD_EXIST:dblExist,FACD_NOSERIE:"",FACD_ESREGALO:0,FACD_IMPORTEREAL:dblImporte,FACD_PRECREAL:dblPrecio,FACD_DESCUENTO:dblDescuento,FACD_PORDESC:objImportes.dblPorcAplica,FACD_PRECFIJO:0,FACD_ESDEVO:0,FACD_CODBARRAS:objProd.getAttribute("PR_CODBARRAS"),FACD_NOTAS:"",FACD_RET_ISR:intRET_ISR,FACD_RET_IVA:intRET_IVA,FACD_RET_FLETE:intRET_FLETE,FACD_UNIDAD_MEDIDA:objProd.getAttribute("PR_UNIDADMEDIDA"),FACD_PUNTOS_U:objImportes.dblPuntos,FACD_NEGOCIO_U:objImportes.dblVNegocio,FACD_PUNTOS:objImportes.dblPuntosImporte,FACD_NEGOCIO:objImportes.dblVNegocioImporte,FACD_PR_CAT1:objProd.getAttribute("PR_CAT1"),FACD_PR_CAT2:objProd.getAttribute("PR_CAT2"),FACD_PR_CAT3:objProd.getAttribute("PR_CAT3"),FACD_PR_CAT4:objProd.getAttribute("PR_CAT4"),FACD_PR_CAT5:objProd.getAttribute("PR_CAT5"),FACD_PR_CAT6:objProd.getAttribute("PR_CAT6"),FACD_PR_CAT7:objProd.getAttribute("PR_CAT7"),FACD_PR_CAT8:objProd.getAttribute("PR_CAT8"),FACD_PR_CAT9:objProd.getAttribute("PR_CAT9"),FACD_PR_CAT10:objProd.getAttribute("PR_CAT10"),FACD_DESC_ORI:0,FACD_REGALO:1,FACD_ID_PROMO:intIdOferta,FACD_DESC_PREC:0,FACD_DESC_PTO:0,FACD_DESC_VN:0,FACD_DESC_LEAL:0};itemId++;jQuery("#FAC_GRID").addRowData(itemId,datarow,"last");_bolPromoAplicaSuma=true;}function _AplicaCambioLista(intIdOferta,intNvaLista){document.getElementById("FAC_LPRECIOS").value=document.getElementById("FCT_LPRECIOS").value;document.getElementById("FCT_LPRECIOS").value=intNvaLista;}function _AplicaStop(intIdOferta,strMsg){bolSaveVta=true;alert(strMsg);}function _AplicaMsg(intIdOferta,strMsg){alert(strMsg);}function _AplicaScript(strNomFxs){if(_debugPromos){_LogPromos("Function execute "+strNomFxs);}try{setTimeout(strNomFxs+";",1);}catch(err){var txt="There was an error when call function "+strNomFxs+" .\n\n";txt+="Error description: "+err.description+" \n\n";txt+="Click OK to continue.\n\n";alert(txt);}}function _LoadLibraryScript(intIdOferta,strNomScript,strNomLib){var strScript="if("+strNomLib.replace(".js","")+"){return true}else{return false}";var strFn=new Function(strScript);try{if(strFn()){_AplicaScript(strNomScript);}}catch(err){if(_countTimePromoLoadJsLib==0){importa("javascript/"+strNomLib);}var delay=1;setTimeout("_LoadLibraryScript("+intIdOferta+",'"+strNomScript+"','"+strNomLib+"');",delay*1000);}}function _ResetAplicaOfertas(intFase){bolSaveVta=true;var bolFoundPromo=false;if(_debugPromos){_LogPromos("Reset Aplica "+intFase);}if(intFase==1){var intLpreciosAnt=parseInt(document.getElementById("FAC_LPRECIOS").value);if(intLpreciosAnt!=0){document.getElementById("FCT_LPRECIOS").value=document.getElementById("FAC_LPRECIOS").value;document.getElementById("FAC_LPRECIOS").value=0;}}var grid=jQuery("#FAC_GRID");var arr=grid.getDataIDs();for(var i=0;i<arr.length;i++){var id=arr[i];var lstRow=grid.getRowData(id);if(parseInt(lstRow.FACD_REGALO)==1){grid.delRowData(id);bolFoundPromo=true;}if(parseInt(lstRow.FACD_ID_PROMO)==1){lstRow.FACD_PORDESC=lstRow.FACD_DESC_ORI;lstRow.FACD_DESC_ORI=0;lstRow.FACD_ID_PROMO=0;lstRowChangePrecio(lstRow,id,grid,false);bolFoundPromo=true;}}lstOfertasActivas=null;_intContaOfertas=-1;if(bolFoundPromo){setSum(false);}}function _LimpiaRegalosPromos(grid){var arr=grid.getDataIDs();for(var t=0;t<arr.length;t++){var id=arr[t];var lstRowAct=grid.getRowData(id);if(parseInt(lstRowAct.FACD_REGALO)==1){grid.delRowData(id);}}}